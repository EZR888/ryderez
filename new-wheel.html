<!DOCTYPE html>
<html>
<head>
  <title>Roulette Wheel Animation</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
    }
    #startButton {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px;
      background: #fff;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button id="startButton">Start Animation</button>

  <script>
    let wheelRadius = 300;
    let wheelCenterX;
    let wheelCenterY;
    let ballRadius = 15;
    let ballX;
    let ballY;
    let ballSpeed;
    let ballAngle;
    let ballFriction = 0.98;
    let isSpinning = false;
    let minSpeed = 0.5;
    let finalIndex;
    let winningNumber;
    let numSlots = 38;
    let slotNumbers = [18, 6, 21, 33, 16, 4, 23, 35, 14, 2, 0, 28, 9, 26, 30, 11, 7, 20, 32, 17, 5, 22, 34, 15, 3, 24, 36, 13, 1, '00', 27, 10, 25, 29, 12, 8, 19, 31];
    let slotAngle;
    let wheelSound;
    let soundLoaded = false;

    function setup() {
      createCanvas(windowWidth, windowHeight);
      wheelCenterX = width / 2;
      wheelCenterY = height / 2;
      slotAngle = 360 / numSlots;
      
      // Add event listener for the start button
      document.getElementById('startButton').addEventListener('click', () => {
        if (!soundLoaded) {
          loadAndPlaySound();
        } else {
          startWheelSpin();
        }
      });
    }

    function draw() {
      background(0);
      drawWheel();

      if (isSpinning) {
        ballAngle += ballSpeed;
        ballSpeed *= ballFriction;

        if (ballSpeed < minSpeed) {
          isSpinning = false;
          finalIndex = calculateSlotIndex();
          winningNumber = slotNumbers[finalIndex];
          console.log(`Ball stopped. Final index: ${finalIndex}, Winning Number: ${winningNumber}`);
          moveBallToWinningSlot();

          // Stop the sound when spinning stops
          if (wheelSound) {
            wheelSound.stop();
          }
        }

        ballX = wheelCenterX + (wheelRadius - ballRadius) * Math.cos(radians(ballAngle));
        ballY = wheelCenterY + (wheelRadius - ballRadius) * Math.sin(radians(ballAngle));
      }

      fill(255);
      ellipse(ballX, ballY, ballRadius * 2, ballRadius * 2);

      if (!isSpinning) {
        fill(255);
        textAlign(CENTER, CENTER);
        textSize(18);
        text(`Winning Number: ${winningNumber}`, width / 2, height - 30);
      }
    }

    function drawWheel() {
      noStroke();
      for (let i = 0; i < numSlots; i++) {
        let angleStart = i * slotAngle * Math.PI / 180;
        let angleEnd = (i + 1) * slotAngle * Math.PI / 180;

        if (slotNumbers[i] === 0 || slotNumbers[i] === '00') {
          fill(0, 128, 0);
        } else {
          fill(i % 2 === 0 ? color(255, 0, 0) : color(0));
        }

        arc(wheelCenterX, wheelCenterY, wheelRadius * 2, wheelRadius * 2, angleStart, angleEnd, PIE);

        let midAngle = (angleStart + angleEnd) / 2;
        let x = wheelCenterX + (wheelRadius - 30) * Math.cos(midAngle);
        let y = wheelCenterY + (wheelRadius - 30) * Math.sin(midAngle);

        fill(255);
        textAlign(CENTER, CENTER);
        textSize(16);
        text(slotNumbers[i], x, y);
      }
    }

    function calculateSlotIndex() {
      let normalizedAngle = (ballAngle % 360 + 360) % 360;
      let anglePerSlot = 360 / numSlots;
      let index = Math.floor(normalizedAngle / anglePerSlot) % numSlots;

      return index;
    }

    function moveBallToWinningSlot() {
      if (!isSpinning) {
        let centerAngle = (finalIndex + 0.5) * slotAngle;
        let correctedAngle = (360 - centerAngle + 360) % 360;

        ballX = wheelCenterX + (wheelRadius - ballRadius) * Math.cos(radians(correctedAngle));
        ballY = wheelCenterY + (wheelRadius - ballRadius) * Math.sin(radians(correctedAngle));
      }
    }

    function loadAndPlaySound() {
      wheelSound = new Howl({
        src: ['https://ezr888.github.io/ryderez/wheel-ball.wav'], // Your audio file URL
        loop: true,
        onload: () => {
          soundLoaded = true;
          console.log('Sound loaded and playing');
          startWheelSpin(); // Start spinning the wheel after sound is loaded
        },
        onloaderror: (id, error) => {
          console.error('Sound load error:', error);
        },
        onplayerror: (id, error) => {
          console.error('Sound play error:', error);
        }
      });

      // Play sound after it's loaded
      wheelSound.play();
    }

    function startWheelSpin() {
      getRandomNumber().then(randomAngle => {
        getRandomNumber().then(randomSpeed => {
          ballAngle = randomAngle * 360;
          ballSpeed = randomSpeed * 100 + 200;
          ballSpeed *= 0.90;

          ballX = wheelCenterX + (wheelRadius - ballRadius) * Math.cos(radians(ballAngle));
          ballY = wheelCenterY + (wheelRadius - ballRadius) * Math.sin(radians(ballAngle));
          isSpinning = true;
        });
      });
    }

    async function getRandomNumber() {
      const crypto = window.crypto || window.msCrypto;
      const array = new Uint32Array(1);
      crypto.getRandomValues(array);
      return array[0] / (Math.pow(2, 32) - 1);
    }
  </script>
</body>
</html>
