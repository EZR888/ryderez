<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mindfulness Coach: Brought to you by AI</title>
  <style>
    :root {
      --bg: #e4f0e7;        /* muted green page background */
      --panel: #fffbe6;     /* light yellow cards */
      --accent: #2e7d5b;    /* deep green */
      --accent-2: #9cc5af;  /* soft green */
      --text: #1f2933;      /* slate */
      --muted: #6b7a86;     /* muted text */
      --bubble-user: #e9f7ff;
      --bubble-sophia: #eef7f0;
      --input-bg: #f5f5f5;  /* light gray for inputs & chat */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      line-height: 1.45;
    }

    header {
      max-width: 1200px; margin: 0 auto 8px; padding: 8px 16px;
      display: flex; justify-content: space-between; align-items: center;
    }

    .shell {
      display: grid;
      grid-template-columns: 2fr 1fr; /* left 2/3, right 1/3 */
      gap: 20px; max-width: 1200px; margin: 24px auto; padding: 0 16px;
    }

    .card {
      background: var(--panel);
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      border: 1px solid #e6ece8;
    }

    .left { padding: 24px; display: grid; gap: 20px; }
    .intro h1 { margin: 0 0 8px; font-size: 28px; color: var(--accent); }
    .intro h2 { margin: 8px 0 12px; font-size: 20px; }

    .form h3 { margin: 0 0 12px; color: var(--accent); }
    .row { display: grid; grid-template-columns: 220px 1fr; align-items: start; gap: 12px; margin: 10px 0; }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%; padding: 10px; border: 1px solid #d3e2d9; border-radius: 10px; background: var(--input-bg);
    }
    input[type="radio"] { width: auto; margin-right: 6px; accent-color: var(--accent); }
    .radio-group { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    textarea { resize: vertical; min-height: 90px; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 4px; }

    .right { display: grid; grid-template-rows: auto 1fr; overflow: hidden; }
    .avatar-wrap { padding: 16px; border-bottom: 1px solid #e6ece8; }
    .avatar-card { background: var(--panel); border-radius: 14px; overflow: hidden; border: 1px solid #e6ece8; text-align: center; }
    .avatar-card img { max-width: 100%; height: auto; display: block; }
    .avatar-caption { padding: 10px; color: var(--muted); font-size: 13px; display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; }
    .mode-pill { background: var(--accent-2); color: #0e3b2a; border-radius: 999px; padding: 2px 8px; font-size: 11px; font-weight: 700; }
    .speak { display: inline-flex; align-items: center; gap: 6px; font-weight: 700; color: #0e3b2a; }

    .chat { display: grid; grid-template-rows: 1fr auto; }
    .log { padding: 16px; overflow: auto; background: var(--input-bg); }
    .msg { max-width: 85%; margin: 8px 0; padding: 10px 12px; border-radius: 12px; border: 1px solid #e2eadf; white-space: pre-wrap; }
    .msg.sophia { background: var(--bubble-sophia); }
    .msg.user { background: var(--bubble-user); margin-left: auto; }
    .msg .by { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }

    .composer { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; padding: 12px; border-top: 1px solid #e6ece8; background: var(--input-bg); }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background: var(--accent); color: white; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    /* 25% smaller Replay buttons inside chat bubbles */
    .msg .replay { font-size: 0.75em; padding: 6px 9px; border-radius: 8px; }
  </style>
</head>
<body>
  <header>
    <div style="font-weight:800;color:var(--accent);">Mindfulness Coach: Brought to you by AI</div>
    <div style="background:var(--accent-2);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;">Dashboard</div>
  </header>

  <main class="shell">
    <!-- LEFT: Intro + Form -->
    <section class="left card">
      <div class="intro">
        <h1>What is mindfulness?</h1>
        <p>Mindfulness is a practice or set of practices that develop the capacity for a calm, focused mind that is open, responsive and sensitive for optimal teaching, advising, management, and learning. Based on neuroscientific research, mindfulness has been shown to help participants reduce stress and revitalize their professional and personal lives by promoting awareness, presence, compassion, concentration, and focus.</p>
        <h2>Those who practice mindfulness often report</h2>
        <ul>
          <li>Feeling more positive</li>
          <li>Reduced emotional reactivity</li>
          <li>Cultivation of compassion</li>
          <li>Minimized drama</li>
          <li>Lowered stress levels</li>
          <li>Appreciation for small things</li>
          <li>Greater connection to goals</li>
        </ul>
        <p>In practicing mindfulness, we invite ourselves to notice experiences as they unfold from moment to moment.</p>
      </div>

      <form class="form" id="intakeForm" onsubmit="return false;">
        <h3>Let us begin</h3>
        <div class="row">
          <label for="name">Your name</label>
          <div>
            <input id="name" type="text" maxlength="25" placeholder="e.g., Alex" />
            <div class="hint">Max 25 characters.</div>
          </div>
        </div>
        <div class="row">
          <label for="why">Why mindfulness?</label>
          <div>
            <textarea id="why" maxlength="500" placeholder="What brings you here today? Up to 500 chars..."></textarea>
            <div class="hint"><span id="whyCount">0</span>/500</div>
          </div>
        </div>
        <div class="row"><label>Practiced before?</label>
          <div class="radio-group">
            <label><input type="radio" name="practiced" value="Yes"> Yes</label>
            <label><input type="radio" name="practiced" value="No"> No</label>
          </div>
        </div>
        <div class="row"><label for="effectiveness">Effectiveness (1-10)</label><input id="effectiveness" type="number" min="1" max="10"></div>
        <div class="row"><label for="frequency">Frequency</label>
          <select id="frequency">
            <option value="">Choose...</option>
            <option>daily</option>
            <option>weekly</option>
            <option>no set schedule</option>
          </select>
        </div>
        <div class="row"><label></label><button id="saveBtn" type="button">Send to Chat</button></div>
      </form>
    </section>

    <!-- RIGHT: Avatar + Chat -->
    <aside class="right card">
      <div class="avatar-wrap">
        <div class="avatar-card">
          <img src="mind.png" alt="Sophia - mindfulness coach avatar">
          <div class="avatar-caption">
            <strong>Sophia</strong> â€” Mindfulness Coach
            <span class="mode-pill" id="modePill">AI: Demo</span>
            <label class="speak"><input type="checkbox" id="speakToggle"> Speak replies</label>
          </div>
        </div>
      </div>

      <div class="chat">
        <div id="log" class="log" aria-live="polite"></div>
        <div class="composer">
          <input id="prompt" type="text" placeholder="Type your message... (Enter to send)" style="background:var(--input-bg);">
          <button id="micBtn" type="button" title="Start voice input">Mic</button>
          <button id="send">Send</button>
        </div>
      </div>
    </aside>
  </main>

<script>
(function(){
  'use strict';
  console.log('[Mindfulness Coach] boot canned v3-keepalive');

  // ==== Elements
  var log = document.getElementById('log');
  var sendBtn = document.getElementById('send');
  var promptInput = document.getElementById('prompt');
  var nameInput = document.getElementById('name');
  var whyInput = document.getElementById('why');
  var whyCount = document.getElementById('whyCount');
  var saveBtn = document.getElementById('saveBtn');
  var speakToggle = document.getElementById('speakToggle');
  var micBtn = document.getElementById('micBtn');

  // ==== State
  var messages = [];
  var coachCtx = { flow: 'generic', step: 0, reason: '' };
  var INTRO = 'Hi, my name is Sophia and I will be guiding you through this mindfulness exercise.';

  // ==== Helpers
  function esc(s){
    s = String(s == null ? '' : s);
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  if (whyInput && whyCount){
    whyInput.addEventListener('input', function(){
      try { whyCount.textContent = String(whyInput.value.length); } catch(e){}
    });
  }

  function addMsg(by, text, role){
    var el = document.createElement('div');
    el.className = 'msg ' + role;
    var speakerBtn = (role === 'sophia') ? '<button class="replay" title="Replay" aria-label="Replay">[Replay]</button>' : '';
    el.innerHTML = '<span class="by">' + esc(by) + '</span>' + esc(text) + ' ' + speakerBtn;
    if (role === 'sophia'){
      var r = el.querySelector('.replay');
      if (r) r.addEventListener('click', function(){ speak(text); });
    }
    if (log){ log.appendChild(el); log.scrollTop = log.scrollHeight; }
  }

  function userLabel(){
    return (nameInput && nameInput.value ? nameInput.value.trim() : '') || 'You';
  }

  // ==== TTS
  var supportsTTS = (typeof window !== 'undefined') && window.speechSynthesis && window.SpeechSynthesisUtterance;
  var selectedVoice = null;

  function pickVoice(){
    if (!supportsTTS) return;
    var voices = window.speechSynthesis.getVoices();
    selectedVoice = voices[0] || null;
  }

  function speak(text){
    if (!supportsTTS || !speakToggle || !speakToggle.checked) return;
    if (!window.__tts_unlocked) {
      window.__tts_queue = window.__tts_queue || [];
      window.__tts_queue.push(String(text || ''));
      return;
    }
    try {
      window.speechSynthesis.cancel();
      var u = new SpeechSynthesisUtterance(String(text||''));
      if (selectedVoice) u.voice = selectedVoice;
      u.lang = (selectedVoice && selectedVoice.lang) ? selectedVoice.lang : 'en-US';
      u.rate = 1.0; u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    } catch(e){ console.warn('TTS error', e); }
  }

  // Autoplay gate: speak intro once on first gesture
  window.__tts_unlocked = false;
  window.__intro_spoken = false;
  function __unlockTTS(){
    if (window.__tts_unlocked) return;
    window.__tts_unlocked = true;
    document.removeEventListener('pointerdown', __unlockTTS);
    document.removeEventListener('keydown', __unlockTTS);
    try {
      var q = window.__tts_queue || [];
      var line = q.length ? q[q.length - 1] : (!window.__intro_spoken ? INTRO : '');
      if (line) { speak(line); window.__intro_spoken = true; }
      window.__tts_queue = [];
    } catch(_){}
  }
  document.addEventListener('pointerdown', __unlockTTS, { once: true });
  document.addEventListener('keydown', __unlockTTS, { once: true });

  if (supportsTTS){
    pickVoice();
    window.speechSynthesis.onvoiceschanged = pickVoice;
    if (speakToggle) speakToggle.checked = true;
  } else {
    if (speakToggle){ speakToggle.checked = false; speakToggle.disabled = true; speakToggle.title = 'Text-to-speech not supported in this browser.'; }
  }

  // ==== Voice Input (Web Speech API) with mic keep-alive
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  var rec = null, recActive = false, micPrimed = false, micStream = null;

  function ensureRecognizer(){
    if (!SR) return null;
    if (rec) return rec;
    rec = new SR();
    rec.lang = 'en-US';
    rec.interimResults = true;
    rec.maxAlternatives = 1;
    rec.continuous = true; // keep running until user stops
    rec.onresult = function(ev){
      var full = '';
      for (var i = ev.resultIndex; i < ev.results.length; i++){
        full += ev.results[i][0].transcript;
      }
      if (promptInput) { promptInput.value = full; }
    };
    rec.onerror = function(e){
      console.warn('STT error', e && e.error);
      recActive = false;
      if (micBtn) micBtn.textContent = 'Mic';
    };
    rec.onend = function(){
      if (recActive) {
        try { rec.start(); } catch(e){}
      } else {
        if (micBtn) micBtn.textContent = 'Mic';
      }
    };
    return rec;
  }

  // Keep mic stream open once per session (prevents repeated prompts)
  function warmupOnce(){
    if (micPrimed) return Promise.resolve();
    micPrimed = true;

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return Promise.resolve();

    return navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,
        noiseSuppression: true
      }
    })
    .then(function(stream){
      micStream = stream; // KEEP IT OPEN for the session
      // Attach to hidden audio so Chrome registers active capture
      try {
        var a = document.createElement('audio');
        a.autoplay = true;
        a.muted = true;
        a.srcObject = stream;
        a.style.display = 'none';
        document.body.appendChild(a);
      } catch(e){}
    })
    .catch(function(err){
      console.warn('mic warmup failed', err);
      micPrimed = false; // allow retry if user changes permission
    });
  }

  function toggleMic(){
    if (!SR){ alert('Speech recognition not supported in this browser.'); return; }
    var r = ensureRecognizer(); if (!r) return;

    // Do the (one-time) permission inside this click to keep it a user gesture
    var warm = warmupOnce();
    warm.finally(function go(){
      if (!recActive){
        try { recActive = true; r.start(); if (micBtn) micBtn.textContent = 'Stop'; }
        catch(e){ console.warn('start failed', e); }
      } else {
        recActive = false;
        try { r.stop(); } catch(e){ console.warn('stop failed', e); }
      }
      // Do NOT speak the intro here; intro is handled once by __unlockTTS
    });
  }
  if (micBtn) micBtn.addEventListener('click', toggleMic);

  // Cleanup mic on unload
  window.addEventListener('beforeunload', function(){
    try { if (micStream) { micStream.getTracks().forEach(function(t){ t.stop(); }); } } catch(e){}
  });

  // ==== Demo brain (rule-based)
  function detectFlow(text){
    var t = (text || '').toLowerCase();
    if (/sleep|insomnia|awake|restless/.test(t)) return 'sleep';
    if (/stress|anx|panic|overwhelm|worry/.test(t)) return 'stress';
    if (/focus|distract|productiv|work|study/.test(t)) return 'focus';
    if (/anger|sad|grief|frustrat|hurt|upset|depress/.test(t)) return 'emotion';
    return 'generic';
  }

  function nextReply(){
    var f = coachCtx.flow, s = coachCtx.step;
    var flows = {
      generic: [
        'Let\'s start with 3 slow breaths: inhale 4, hold 1, exhale 6 - three times. Notice one sensation in the body. What changed?',
        'Try the 5-4-3-2-1 grounding: name 5 you see, 4 you feel, 3 you hear, 2 you smell, 1 you taste. Share one thing that stood out.',
        'Do a 60 second body scan from toes to head. Where is there ease or tension? Name one spot to soften on the next exhale.',
        'Label thoughts gently: when a thought arises, say "thinking" once, then return to the breath. What thought popped up most?',
        'Values check: pick one word now (calm, clarity, kindness, focus). Describe one tiny act that fits it today.',
        'Plan a 2 minute practice for later: set a reminder, choose a place, choose a cue. When can you do it?'
      ],
      stress: [
        'Do 4-2-6 breathing for 1 minute: inhale 4, hold 2, exhale 6. On exhale, drop the shoulders. What changed?',
        'Add a brief muscle release: clench fists 5 seconds, release on the exhale. Where do you feel relief?',
        'Name the top stressor in 5 words or fewer. What is one controllable step within 10 minutes?',
        'Try a quick OODA loop: Observe, Orient, Decide, Act - pick one small decision now. What is it?'
      ],
      sleep: [
        'Try 4-7-8 breathing for 2 minutes in bed: inhale 4, hold 7, exhale 8. Keep the breath light. Will you try that tonight?',
        'Run a short body scan: toes to head, 30-45 seconds. If thoughts intrude, whisper "thinking" and return. What routine change could help?',
        'If awake at night: get up, dim light, read 10 minutes, then try 4-7-8 again. What wind down time can you commit to?'
      ],
      focus: [
        'One minute anchor: feel the breath at the nostrils. Count 10 breaths. If you lose count, restart. Ready to try?',
        'Pick a 10 minute focus sprint (timer on). Remove one distraction you control. What task will you do for 10 minutes?',
        'At the end, note: one win, one friction, one improvement. What was the win?'
      ],
      emotion: [
        'Place a hand on chest. Breathe slowly for six breaths. Name the emotion once. What word fits best?',
        'Ask the feeling: "What do you need right now?" Write the first answer that comes. What did it say?',
        'Choose a wise next step under 2 minutes that respects that need. What will you do now?'
      ]
    };
    var steps = flows[f] || flows.generic;
    var reply;
    if (s >= steps.length){
      reply = 'Nice progress. Let\'s lock it in: schedule a 2 minute practice today and a 5 minute one this week. Type "begin" to restart, or say a topic (sleep, stress, focus).';
      coachCtx.step = 0;
      return reply;
    }
    reply = steps[s];
    coachCtx.step = s + 1;
    return reply;
  }

  function mockCoach(chatMessages){
    var lastMsg = chatMessages[chatMessages.length - 1] || {};
    var last = String(lastMsg.content || '').toLowerCase().trim();
    if (last === 'reset' || last === 'restart') { coachCtx.step = 0; }
    if (/begin|start/.test(last)) { coachCtx.step = 0; }
    if (coachCtx.step === 0){
      var hint = last || coachCtx.reason || '';
      coachCtx.flow = detectFlow(hint);
    }
    return nextReply();
  }

  function toLLMMessages(){
    return [{ role:'system', content:'You are Sophia, a mindfulness coach.' }].concat(messages);
  }

  // Intro bubble on load (voice will queue until unlock)
  addMsg('Sophia', INTRO, 'sophia');
  speak(INTRO);

  // Intake -> response
  if (saveBtn){
    saveBtn.addEventListener('click', function(){
      var practicedEl = document.querySelector('input[name="practiced"]:checked');
      var practiced = practicedEl ? practicedEl.value : 'N/A';
      var effEl = document.getElementById('effectiveness');
      var eff = (effEl && effEl.value) ? effEl.value : 'N/A';
      var freqEl = document.getElementById('frequency');
      var freq = (freqEl && freqEl.value) ? freqEl.value : 'N/A';
      var why = (whyInput && whyInput.value) ? whyInput.value.trim() : '';

      var lines = [
        'Name: ' + userLabel(),
        'Why mindfulness: ' + (why || 'N/A'),
        'Practiced before: ' + practiced,
        'Effectiveness: ' + eff,
        'Frequency: ' + freq
      ];
      addMsg('Intake Summary', lines.join('\n'), 'sophia');

      coachCtx.reason = why;
      coachCtx.step = 0;

      messages.push({ role:'user', content:'Profile - name: ' + userLabel() + '; reason: ' + (why || 'n/a') + '; practiced: ' + practiced + '; effectiveness: ' + eff + '; frequency: ' + freq + '.' });

      var reply = mockCoach(toLLMMessages());
      messages.push({ role:'assistant', content: reply });
      addMsg('Sophia', reply, 'sophia');
      speak(reply);
    });
  }

  // Chat -> response
  function sendUserMessage(){
    var val = (promptInput && promptInput.value) ? promptInput.value.trim() : '';
    if (!val) return;
    addMsg(userLabel(), val, 'user');
    messages.push({ role:'user', content: val });
    if (promptInput) promptInput.value = '';

    var reply = mockCoach(toLLMMessages());
    messages.push({ role:'assistant', content: reply });
    addMsg('Sophia', reply, 'sophia');
    speak(reply);
  }

  if (sendBtn) sendBtn.addEventListener('click', sendUserMessage);
  if (promptInput){
    promptInput.addEventListener('keydown', function(e){
      if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendUserMessage(); }
    });
  }
})();
</script>

</body>
</html>
