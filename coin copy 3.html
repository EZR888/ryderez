<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roulette Wheels and Coin Flipper</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000; /* Set background to black */
      color: #fff; /* Default text color for better visibility */
      font-family: Arial, sans-serif;
    }
    .page-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .wheels-container {
      display: flex;
      justify-content: space-around;
      width: 80%;
      margin-bottom: 20px;
    }
    .wheel-container {
      border: 2px solid #ffffff;
      border-radius: 50%;
      overflow: hidden;
      position: relative;
    }
    .button-container {
      margin: 10px;
    }
    .button {
      margin: 5px;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #45a049;
    }
    .caption {
      margin: 10px;
      font-size: 1.2em;
      font-weight: bold;
    }
    #coin {
      width: 100px;
      height: 100px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid white;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #333;
      color: #fff;
    }
    tr:nth-child(even) {
      background-color: #222;
    }
    tr:nth-child(odd) {
      background-color: #444;
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <h1 class="caption">Roulette Wheels</h1>
    <div class="wheels-container">
      <div class="wheel-container">
        <div id="output1"></div>
      </div>
      <div class="wheel-container">
        <div id="output2"></div>
      </div>
    </div>
    <div class="button-container">
      <button id="startButton1" class="button"><b>Spin Wheel 1</b></button>
      <button id="startButton2" class="button"><b>Spin Wheel 2</b></button>
      <button id="saveDataButton" class="button"><b>Save Data</b></button>
      <button id="accessSimulatorButton" class="button"><b>Access Simulator</b></button>
      <button id="flipButton" class="button"><b>Flip Coin</b></button>
    </div>
    <div class="table-container">
      <p class="caption">History</p>
      <div id="historyTableContainer">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Wheel 1</th>
              <th>Wheel 2</th>
              <th>Coin Toss</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <img id="coin" src="heads.png" alt="Coin">
      <div id="result">Click "Flip Coin" to Start</div>
    </div>
  </div>

  <script>
    let history = [];

    function createWheelSketch(canvasId, startButtonId, wheelNumber) {
      return function(p) {
        let wheelRadius = 185;
        let wheelCenterX;
        let wheelCenterY;
        let ballRadius = 11;
        let ballX;
        let ballY;
        let ballSpeed;
        let ballAngle;
        let ballFriction = 0.9945;
        let isSpinning = false;
        let minSpeed = 0.85;
        let finalIndex;
        let winningNumber;
        let numSlots = 38;
        let slotNumbers = [18, 6, 21, 33, 16, 4, 23, 35, 14, 2, 0, 28, 9, 26, 30, 11, 7, 20, 32, 17, 5, 22, 34, 15, 3, 24, 36, 13, 1, '00', 27, 10, 25, 29, 12, 8, 19, 31];
        let slotAngle;
        let wheelSound;
        let soundLoaded = false;

        p.setup = function() {
          p.createCanvas(390, 390).parent(canvasId);
          wheelCenterX = p.width / 2;
          wheelCenterY = p.height / 2;
          slotAngle = 360 / numSlots;
          document.getElementById(startButtonId).addEventListener('click', startWheelSpin);
          loadAndPlaySound();
        }

        p.draw = function() {
          p.background(0);
          drawWheel();

          if (isSpinning) {
            ballAngle += ballSpeed;
            ballSpeed *= ballFriction;

            if (ballSpeed < minSpeed) {
              isSpinning = false;
              finalIndex = calculateSlotIndex();
              winningNumber = slotNumbers[finalIndex];
              moveBallToWinningSlot();

              if (wheelSound) {
                wheelSound.stop();
              }

              if (winningNumber !== undefined) {
                history.push({
                  wheel1: wheelNumber === 1 ? winningNumber : '',
                  wheel2: wheelNumber === 2 ? winningNumber : '',
                  coinToss: ''
                });
                updateHistoryTable();
              }
            }

            ballX = wheelCenterX + (wheelRadius - ballRadius) * p.cos(p.radians(ballAngle));
            ballY = wheelCenterY + (wheelRadius - ballRadius) * p.sin(p.radians(ballAngle));
            p.fill(255);
            p.ellipse(ballX, ballY, ballRadius * 2);
          } else {
            p.fill(255);
            p.ellipse(ballX, ballY, ballRadius * 2);
          }
        }

        function drawWheel() {
          p.stroke(139, 69, 19);
          p.strokeWeight(4);
          p.noFill();
          p.ellipse(wheelCenterX, wheelCenterY, wheelRadius * 2, wheelRadius * 2);

          for (let i = 0; i < numSlots; i++) {
            let angleStart = p.radians(i * slotAngle);
            let angleEnd = p.radians((i + 1) * slotAngle);
            p.fill((i % 2 === 0) ? 'red' : 'black');
            if (slotNumbers[i] === 0 || slotNumbers[i] === '00') {
              p.fill('green');
            }
            p.arc(wheelCenterX, wheelCenterY, wheelRadius * 2, wheelRadius * 2, angleStart, angleEnd, p.PIE);

            let midAngle = (angleStart + angleEnd) / 2;
            let x = wheelCenterX + (wheelRadius - 30) * Math.cos(midAngle);
            let y = wheelCenterY + (wheelRadius - 30) * Math.sin(midAngle);

            p.fill(255);
            p.textAlign(p.CENTER, p.CENTER);
            p.textSize(13);
            p.text(slotNumbers[i], x, y);
          }

          p.fill(210, 180, 140);
          p.ellipse(wheelCenterX, wheelCenterY, 30, 30);
        }

        function calculateSlotIndex() {
          let normalizedAngle = (ballAngle % 360 + 360) % 360;
          let anglePerSlot = 360 / numSlots;
          let index = Math.floor(normalizedAngle / anglePerSlot) % numSlots;
          return index;
        }

        function moveBallToWinningSlot() {
          if (!isSpinning) {
            let centerAngle = (finalIndex + 0.5) * slotAngle;
            let correctedAngle = (360 - centerAngle + 360) % 360;

            ballX = wheelCenterX + (wheelRadius - ballRadius) * Math.cos(p.radians(correctedAngle));
            ballY = wheelCenterY + (wheelRadius - ballRadius) * Math.sin(p.radians(correctedAngle));
          }
        }

        function loadAndPlaySound() {
          wheelSound = new Howl({
            src: ['wheel-ball.wav'],
            loop: true,
            onload: () => {
              soundLoaded = true;
              console.log('Sound loaded');
            },
            onloaderror: (id, error) => {
              console.error('Sound load error:', error);
            },
            onplayerror: (id, error) => {
              console.error('Sound play error:', error);
            }
          });
        }

        function startWheelSpin() {
          if (!isSpinning) {
            isSpinning = true;
            ballAngle = 0;
            ballSpeed = p.random(10, 20);
            wheelSound.play();
          }
        }

        function updateHistoryTable() {
          let tableBody = document.querySelector('#historyTable tbody');
          tableBody.innerHTML = '';
          history.forEach(entry => {
            let row = document.createElement('tr');
            row.innerHTML = `
              <td>${entry.wheel1}</td>
              <td>${entry.wheel2}</td>
              <td>${entry.coinToss}</td>
            `;
            tableBody.appendChild(row);
          });
        }
      }
    }

    new p5(createWheelSketch('output1', 'startButton1', 1));
    new p5(createWheelSketch('output2', 'startButton2', 2));

    let coin;
    let resultText;
    let tossing = false;

    function setupCoinFlipper() {
      coin = document.getElementById('coin');
      resultText = document.getElementById('result');
    }

    function tossCoin() {
      if (tossing) return;
      tossing = true;

      resultText.innerHTML = 'Tossing...';

      let angle = 0;
      let rotationSpeed = 100;
      let frames = 0;

      function animateCoin() {
        if (frames < 60) {
          angle += rotationSpeed;
          coin.style.transform = `rotate(${angle}deg)`;
          frames++;
          requestAnimationFrame(animateCoin);
        } else {
          let result = Math.random() > 0.5 ? 'heads' : 'tails';
          coin.src = result === 'heads' ? 'heads.png' : 'tails.png';
          resultText.innerHTML = result.charAt(0).toUpperCase() + result.slice(1);

          let tableBody = document.querySelector('#historyTable tbody');
          if (tableBody.rows.length > 0) {
            tableBody.rows[tableBody.rows.length - 1].cells[2].innerText = result;
          }

          history[history.length - 1].coinToss = result; // Update the coin toss history
          tossing = false;
        }
      }

      animateCoin();
    }

    function exportTotalsToCSV(data, filename) {
      if (!Array.isArray(data)) {
        console.error('Data is not an array');
        return;
      }

      const csvContent = "data:text/csv;charset=utf-8,"
          + "Wheel 1,Wheel 2,Coin Toss\n"
          + data.map(entry => `${entry.wheel1},${entry.wheel2},${entry.coinToss}`).join("\n");
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
    }

    function clearAndResetTotals() {
      history = [];
      updateHistoryTable();
    }

    setupCoinFlipper();

    document.getElementById('flipButton').addEventListener('click', tossCoin);
    document.getElementById('saveDataButton').addEventListener('click', () => exportTotalsToCSV(history, 'history.csv'));
    document.getElementById('accessSimulatorButton').addEventListener('click', clearAndResetTotals);
  </script>
</body>
</html>
