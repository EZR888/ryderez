<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Winning Edge</title>
  <style>
 /* ==========  Global layout / colours  ========== */
body{
    font-family:Arial,Helvetica,sans-serif;
    padding:10px;
    background: #086d22;
    color:lightgreen;
}
.container{display:flex;height:100vh}

/* ---------- buttons ---------- */
button{
    margin:12px;
    padding:9px 9px;
    background: salmon;          /* dark-green #064d06 */
    color:#fff;
    border:none;
    cursor:pointer;
    font-size:16px;
    border-radius:4px;
}
button:hover{background:slategray}

/* ---------- inputs ---------- */
input[type="number"],
input[type="text"]{
    width:40px;
    text-align:center;
    font-size:16px;
    margin:2px;
    background:#fffbcc;          /* light-yellow */
}

/* ---------- top-numbers input strip ---------- */
#top18Inputs {
    display: none;
}


/* ---------- table styling ---------- */
table{
    border-collapse:collapse;
    margin-top:10px;
    width:100%;
    background:#000;
}
th,td{
    border:1px solid #666;
    width:30px;height:30px;
    text-align:center;
    color:lightgray;
}
th{background:#333;color:#fff}

.selected-top-skip{background:#ff0!important;color:#000;font-weight:bold}
.top18-selected   {background:orange!important;color:#000;font-weight:bold}
.missed-over-25   {background:red!important;color:#fff;font-weight:bold}
.red-dot,.orange-dot{
    width:14px;height:14px;border-radius:50%;margin:auto
}
.red-dot   {background:red}
.orange-dot{background:orange}
table tr:hover{background:#444}

#skipFrequencyContainer td{font-size:17px}
#newDrawingInputs{margin-left:12px}

/* ==========  Modal  ========== */
.modal{
    display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;
    overflow:auto;background:rgba(0,0,0,.4);
}
.modal-content {
    background: black;
    color: lightgreen;
    padding: 20px;
    border: 1px solid #888;
    width: 70%; /* ⬅️ Try reducing from 54% to something like 38% */
    max-width: 480px; /* ⬅️ Add a max-width for safety on large screens */
    max-height: 80vh;
    overflow-y: auto;

    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%); /* ⬅️ This keeps it centered regardless of width */
}

.close-button {
  position: absolute;
  top: 12px;
  right: 16px;
  font-size: 28px;
  font-weight: bold;
  color: lightgray;
  cursor: pointer;
}

.close-button:hover {
  color: white;
}

/* ---------- modal footer (Generate / Export buttons) ---------- */
.modal-footer{
    margin:18px 0 8px;display:flex;gap:16px;justify-content:center
}

/* ==========  Powerball picker block  ========== */
#load1Button{display:none}              /* hidden until 69-number game loaded */

#pbBlock{
    display:none;                       /* shown only for 26-number game     */
    gap:6px;margin:12px 0 8px 12px;
    align-items:center
}
#pbBlock input{
    width:36px;background:#fffbcc
}

/* ==========  Items hidden until data have loaded  ========== */
/* ==========  Items hidden until data have loaded  ========== */
#newDrawingInputs,
#top18Inputs,
button[onclick="exportGeneratedSets()"],
button[onclick="exportBestSets()"],
button[onclick="updateReverseHitsTop18()"] {
  display: none;
}

#newDrawingInputs > button {
  display: none;
}

                
button img{
    width:150px;          /* pick a size that suits your artwork -- */
    height:auto;          /*   or set both width & height           */
    display:block;        /* removes the small baseline gap         */
    pointer-events:none;  /* so clicks go to <button>, not the <img>*/
}

/* OPTIONAL – darken on hover exactly as before                    */
button:hover img{
    filter:brightness(1.15);   /* make the PNG a bit brighter on hover */
}

button.active{
    outline:3px solid gold;          /* bright border        */
    outline-offset:2px;              /* little gap           */
    filter:brightness(1.25);         /* make PNG pop a bit   */
    /* you can tweak / add a drop-shadow etc. if you prefer  */
}

/* ---------- image buttons ---------- */
.gameBtn{
    background:#000;          /* black behind the PNG  */
    padding:10px;             /* keep a little space   */
    border:none;
    cursor:pointer;
    border-radius:6px;
    margin:12px;
}
.gameBtn:hover      img{filter:brightness(1.2);}  /* “light up” on hover   */
.gameBtn.active     {
    outline:3px solid gold;
    outline-offset:2px;
    filter:brightness(1.25);
}

/* keep the old style for any other text buttons */
button:not(.gameBtn){
    background:#064d06;
}

input.dimmed {
    opacity: 0.4;
    pointer-events: none;
}

#top18Inputs > div {
    display: inline-block;
}

#matchResults div {
  margin: 4px 0;
  font-weight: bold;
}

/* Remove spinner arrows in number inputs (Chrome, Safari, Edge) */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Remove spinner arrows in Firefox */
input[type=number] {
    -moz-appearance: textfield;
}

/* 🎯 Imported from Roulette Project – Scoped Button Styles */
.button {
  font-size: 100%;
  padding: 6px 12px;
  margin: 5px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.2s ease;
  background-color: #444; /* fallback if no .button-* class applied */
  color: white !important;
}
.button:hover {
  opacity: 0.8;
}
.button-single {
  background-color: salmon;
  color: black;
}
.button-purple {
  background-color: purple;
  color: white;
}

h1 {
  font-family: 'Comic Sans MS', cursive;
  font-style: italic;
  font-size: 54px;
  text-align: center;
  position: relative;
  margin: auto;
  width: auto;
  color: gold;
}

/* ---------- headings ---------- */
h2{margin:0 0 8px;color: lightgreen}
h3{margin:0 0 15px;color: gold}

.bar-entry {
  display: flex;
  align-items: center;
  margin: 4px 0;
  font-family: monospace;
  font-size: 14px;
}
.bar-label {
  width: 80px;
  color: gold;
  text-align: right;
  padding-right: 6px;
}
.bar {
  height: 14px;
  background-color: lightgreen;
  margin-left: 4px;
}

#splashScreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: green;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#splashImage {
  max-width: 90%;
  max-height: 80vh;
}

#splashText {
  margin-top: 20px;
  color: gold;
  font-size: 32px;
  font-weight: bold;
  font-family: 'Comic Sans MS', cursive;
}

 .green-dot{
    width:14px;height:14px;border-radius:50%;margin:auto;background:#32cd32;
}

.hot-dot{
  width:14px;height:14px;border-radius:50%;margin:auto;
  background:#00bfff; /* deepskyblue for "Hot" */
}

  </style>
</head>
<body>

<div id="splashScreen">
<!-- 🔥 Main Title + Subtitle Section -->
<div style="text-align: center; margin-top: 40px; margin-bottom: 30px;">
  <h1 style="
    font-family: 'Comic Sans MS', cursive;
    font-style: italic;
    font-size: 64px;
    color: gold;
    margin-bottom: 12px;
    text-shadow: 2px 2px 4px black;
  ">
    The Winning Edge
  </h1>
  <div style="
    font-size: 24px;
    color: lime;
    font-family: 'Arial', sans-serif;
    font-weight: 300;
    text-shadow: 1px 1px 2px #000;
  ">
    Statistically Optimized Lotto Picks
      <br><br><br>
  </div>
</div>

<div id="splashText">Loading your luck...</div><br><br>
  <img src="potogold.gif" alt="Loading your luck..." id="splashImage">
  
</div>

<!-- 🔥 Main Title + Subtitle Section -->
<div style="text-align: center; margin-top: 40px; margin-bottom: 30px;">
  <h1 style="
    font-family: 'Comic Sans MS', cursive;
    font-style: italic;
    font-size: 64px;
    color: gold;
    margin-bottom: 12px;
    text-shadow: 2px 2px 4px black;
  ">
    The Winning Edge
  </h1>
  <div style="
    font-size: 24px;
    color: lime;
    font-family: 'Arial', sans-serif;
    font-weight: 300;
    text-shadow: 1px 1px 2px #000;
  ">
    Statistically Optimized Lotto Picks
  </div>
</div>

<br>
<h2>Load a Lotto Dataset</h2>

<button id="powerball"      class="gameBtn">
    <img src="powerball.png" alt="Load 69-number game">
</button>

<button id="load1Button"    class="gameBtn">
    <img src="power.png"     alt="Load PB-only game">
</button>

<button id="load39Button" class="gameBtn">
    <img src="Fantasy5.png" alt="Load 39-number game">
</button>
<span id="lastDrawingDisplay" style="font-weight: bold; margin-left: 30px; font-size: 24px;">
  <span style="color: gold;">Last Drawing #:</span>
  <span id="lastDrawingNumber" style="color: lightyellow;">–</span>
</span>



<div id="pbBlock">
    <h3 style="margin:0 6px 0 0;">Pick Powerball Number</h3>
    <input><input><input><input><input>
</div>
<br>

<button id="methodologyBtn" class="button button-single">📘 Methodology</button>

<button id="showHistogramBtn" class="button button-single" style="display:none;">
  📊 Show Points Histogram
</button>

<button id="checkNumbersButton" class="button button-single" style="margin-left: 10px;">
  ✅ Check Numbers
</button>
<br><br>

<h2 id="top18Label">Top Numbers (Editable)</h2>
    <div id="top18Inputs"></div>
<button id="updateHitsBtn" class="button button-single">🔄 Update Hits Table</button>
<button id="autoPickTopBtn" class="button button-single">
  🧠 Auto-Pick Top Numbers
</button>
<button id="loadTop18Button" class="button button-single">📂 Load Top #'s</button><br>

<div id="loadTop18Modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="closeLoadModal">&times;</span>
        <h2>Load Top 18 Numbers</h2>
        <input type="file" id="loadTop18FileInput">
    </div>
</div>

<button id="generateWheelButton" class="button button-purple" style="display:none">
  🎯 Generate Wheel
</button>

<button id="quick12Button" class="button button-single" style="display:none">
  ⚡ 12‑Number Quick
</button>

<button id="systemPicksButton" class="button button-single" style="display:none">
  🤖 System Picks
</button>



<br>
	    
<br><br>

<div id="wheelModal" class="modal"><div class="modal-content">
<span class="close-button close-wheel">&times;</span>
    <h2>Generated Wheel Sets</h2>

    <div id="modalWheelOutput" style="white-space:pre-wrap"></div>

    <div style="margin-top:10px">
        <label style="color:lightgreen">How many sets to generate? </label>
        <input type="number" id="modalSetCountChoice" value="6" min="1" max="100"
               style="width:50px;font-size:16px;background:#333;color:#fff">
        <br>
        <label style="color:lightgreen">Show Best Sets: </label>
        <input type="number" id="modalBestSetCount" value="5" min="1"
               style="width:50px;font-size:16px;background:#333;color:#fff">
    </div>

    <div class="modal-footer">
        <button id="generateSetsModalButton">🎯 Generate Sets</button>
        <button id="pickBestSetsModal">✨ Pick Best</button>
        <button id="exportAllBtn">⬇️ Export All</button>
        <button id="exportBestBtn">⬇️ Export Best</button>
    </div>
</div></div>

<div id="wheelOutput" style="display: none;"></div>

<div id="hitsTableSection" style="display: none;">
    <h2>Hits Table (Last 25 Drawings)</h2>
    <div id="latestDrawingComment" style="margin-bottom: 10px; font-weight: bold;"></div>
    <div id="recentDrawsContainer"></div>
</div>

<div id="methodologyModal" class="modal">
  <div class="modal-content">
    <span class="close-button" id="closeMethodology">&times;</span>
    <h2>How This Works</h2>
    <p style="line-height: 1.6; font-size: 16px;">
      <strong>Does this improve my odds?</strong><br><br>
      While the jackpot odds stay the same, this system boosts your chances of matching 3 or 4 numbers by:
      <ul>
        <li>Picking statistically stronger numbers (based on 10 million simulated draws)</li>
        <li>Filtering out combos with bad sums or recent full draws</li>
        <li>Favoring balanced spreads, no duplicates, and strategic skip history</li>
        <li>Covering more possible 3-number combos with fewer tickets</li>
      </ul>
      This isn’t magic — just smarter filtering, statistical scoring, and optimized wheel coverage.
    </p>
  </div>
</div>


<h2>Hits Table</h2> 
<h3>Last 25 Drawings and Top Skip Numbers Highlighted</h3>
<div id="reverseHitsContainer"></div>
<br>
<h2>Skip Frequency Table</h2>
<h3>Number of Drawings Between Hits</h3>
<div id="skipFrequencyContainer"></div>



<!-- ✅ Check Winning Numbers Modal -->
<div id="checkNumbersModal" class="modal">
  <div class="modal-content" style="width: 60%; max-width: none;">
<span class="close-button close-check">&times;</span>
<h2>Check Your Numbers</h2>
<br>
<div style="display: flex; gap: 40px;">

  <!-- Left Side: Prize Table -->
  <div style="flex: 1;">
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
  <label style="font-size: 20px; font-weight: bold; color: orange;">Prize Table</label>
  <div id="drawNumberLabel" style="color: lightyellow; font-size: 18px;"></div>
</div>
    <table id="prizeTable" style="width: 100%; border-collapse: collapse; color: lightgreen;">
      <thead>
        <tr>
          <th style="border: 1px solid gray; padding: 6px;">Match Tier</th>
          <th style="border: 1px solid gray; padding: 6px;">Winners</th>
          <th style="border: 1px solid gray; padding: 6px;">Prize</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <br><br>
  </div>

            
      <!-- Left Side: Winning Numbers + Match Results -->
      <div style="flex: 1;">
<div id="checkInputFields">
  <label style="font-size: 20px; font-weight: bold; color: orange;">Winning Numbers:</label><br>
  <div style="display: flex; align-items: center; gap: 10px; margin-top: 6px;">
    <div id="winningNumbersDisplay" style="display: flex; gap: 10px; font-size: 20px; color: gold;"></div>
    <div id="winningPBDisplay" style="font-size: 20px; color: gold;"></div>
  </div>
</div>

        <br>
        <div id="matchResults" style="margin-top: 10px; font-weight: bold;"></div>
      </div>

    </div>
  </div>
</div>


<!-- 🔳 Scrolling Histogram Modal -->
<div id="histogramModal" class="modal">
  <div class="modal-content" style="max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
    <span id="closeHistogramModal" class="close-button" style="top: 10px; right: 14px;">&times;</span>
    <h2 style="margin-top: 0; color: lightgreen;">Points Per Drawing (Latest on Top)</h2>
    <div id="histogramContent"></div>
  </div>
</div>

<div id="autoPickModal" class="modal">
  <div class="modal-content" style="width: 400px; max-width: 90%;">
    <span class="close-button" id="closeAutoPickModal">&times;</span>
    <h2>Auto-Pick Top Numbers</h2>
    
    <label for="weeksInput">Number of Drawings (max 25):</label>
    <input type="number" id="weeksInput" min="1" max="25" value="25" style="width:60px"><br><br>

    <label>Select Coverage:</label><br>
    <input type="radio" name="coverage" value="5" id="coverage5">
    <label for="coverage5">Top 5</label><br>
    <input type="radio" name="coverage" value="12" id="coverage12">
    <label for="coverage12">Top 12</label><br>
    <input type="radio" name="coverage" value="18" id="coverage18" checked>
    <label for="coverage18">Top 18</label><br><br>

    <button id="runAutoPick" class="button button-purple">🎯 Generate</button>
	<button id="saveTop18Button"
        	class="button button-single"
        	style="display:none;">💾 Save Top #'s</button>

  </div>
</div>

<script>

let systemPicks = new Set();  // ✅ holds numbers to show in the "Picks" column

let latestDrawingNumber = null;
let fullData = [];
let top18 = [];
let pastDrawings = [];
let totalNumbersGlobal = 39, generatedSets=[];
let skipDataGlobal={}, sinceMap={}, referenceData={};
let top18From69 = [];
let fullDataFrom69 = [], skipDataGlobalFrom69 = {}, sinceMapFrom69 = {}, pastDrawingsFrom69 = [];
let activeGameMode = null; // To store the currently active game mode

const qs  = sel => document.querySelector(sel);
const qsa = sel => Array.from(document.querySelectorAll(sel));

/* ── BUTTON VISIBILITY LOGIC ───────────────────────────────────── */
const btn39 = qs('#load39Button'),
      btn69 = qs('#powerball'),
      btn1  = qs('#load1Button'),
      pbBlk = qs('#pbBlock');
      
const closeButton = document.querySelector('.close-button');
const wheelModal = document.getElementById('wheelModal');
const continueButton = document.getElementById('continueButton');
const saveButtonModal = document.getElementById('saveGeneratedSetsModal');
const pickBestSetsButtonModal = document.getElementById('pickBestSetsModal');

let skipDataFrom69 = {};

btn69.onclick = () => {
  loadCSVFile('lotto_69.txt', 69, () => {
    activeGameMode = 69;
    generateTopNumbersAndRender(true);

    // Save supporting data for restoring later
    pastDrawingsFrom69 = [...pastDrawings];
    skipDataFrom69 = JSON.parse(JSON.stringify(skipDataGlobal));
    sinceMapFrom69 = { ...sinceMap };
    fullDataFrom69 = [...fullData];

    console.log("✅ fullData sample:", fullData.slice(0, 3));

    if (btn1) {
      btn1.style.display = 'inline-block';
    } else {
      console.warn("⚠️ 'btn1' not found in DOM at time of access.");
    }

    hidePBblock();
	qs('#generateWheelButton').style.display = 'inline-block';
    qs('#quick12Button').style.display = 'none';
    qs('#systemPicksButton').style.display = 'inline-block';   // ⬅️ add this
    qs('#checkNumbersButton').style.display = 'inline-block';
    document.getElementById('showHistogramBtn').style.display = 'inline-block';
    setupHistogramListener();
        highlight(btn69);
    
    // ✅ Show Top18-related controls again when returning to 69 mode
document.getElementById('top18Inputs').style.display = 'flex';
const label = document.getElementById('top18Label');
if (label) label.style.display = 'block';

[
  'updateHitsBtn',
  'autoPickTopBtn',
  'saveTop18Button',
  'loadTop18Button'
].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.style.display = 'inline-block';
});


    const pbSpan = document.getElementById('checkPBSpan');
    if (pbSpan) pbSpan.style.display = 'inline';

    // ✅ Attach histogram listener only after data is loaded
  });
};

btn1.onclick = () => {
  highlight(btn1);
  totalNumbersGlobal = 26;
  activeGameMode = 26;

  showPBblock();
  qs('#generateWheelButton').style.display = 'none';
  qs('#checkNumbersButton').style.display = 'none';
  document.getElementById('showHistogramBtn').style.display = 'none';
  qs('#quick12Button').style.display = 'none';
  qs('#systemPicksButton').style.display = 'none';   
 
  const checkPBSpan = document.getElementById('checkPBSpan');
  if (checkPBSpan) checkPBSpan.style.display = 'none';

  // ✅ Hide Top 18 label and input row
  document.getElementById('top18Inputs').style.display = 'none';
  const label = document.getElementById('top18Label');
  if (label) label.style.display = 'none';
  
    // Hide all Top18-related inputs and buttons
  document.getElementById('top18Inputs').style.display = 'none';
  document.getElementById('updateHitsBtn').style.display = 'none';
  document.getElementById('autoPickTopBtn').style.display = 'none';
  document.getElementById('saveTop18Button').style.display = 'none';
  document.getElementById('loadTop18Button').style.display = 'none';
  document.getElementById('top18Label').style.display = 'none';

  // ✅ Load the 1-number data fresh
  loadCSVFile('lotto_1.txt', 26, () => {
    // 🔄 Recalculate top18 based on the skip table
    const highlighted = [];
    for (let number = 1; number <= totalNumbersGlobal; number++) {
      const val = skipDataGlobal.skipTable[number]?.reduce((a, b) => a + b, 0) || 0;
      highlighted.push({ number, val });
    }
    highlighted.sort((a, b) => b.val - a.val);
    top18 = highlighted.slice(0, 12).map(x => x.number).sort((a, b) => a - b);

    // ⬇️ Fill input fields anyway, for consistency (even if hidden)
    const top18InputsDiv = document.getElementById('top18Inputs');
    top18InputsDiv.innerHTML = '';
    for (let i = 0; i < top18.length; i++) {
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.value = top18[i];
      top18InputsDiv.appendChild(inp);
    }

    console.log('🔁 Recalculated 1-number Top 18:', top18);

    updateReverseHitsTop18(); // ✅ This fills in the Top column
    rehighlightSkipTableFromTop18();
  });
};

btn39.onclick = () => {
  loadCSVFile('lotto_39.txt', 39, () => {
    activeGameMode = 39;
    generateTopNumbersAndRender(false);
    btn1.style.display = 'none';
    hidePBblock();
    highlight(btn39);
    qs('#generateWheelButton').style.display = 'inline-block';
    qs('#quick12Button').style.display = 'inline-block';
    qs('#systemPicksButton').style.display = 'inline-block';   // ⬅️ add this
    qs('#checkNumbersButton').style.display = 'inline-block';
    document.getElementById('showHistogramBtn').style.display = 'inline-block';
    setupHistogramListener();
    
    // ✅ Show Top18-related controls again when returning to 69 mode
document.getElementById('top18Inputs').style.display = 'flex';
const label = document.getElementById('top18Label');
if (label) label.style.display = 'block';

[
  'updateHitsBtn',
  'autoPickTopBtn',
  'saveTop18Button',
  'loadTop18Button'
].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.style.display = 'inline-block';
});

    
    const checkPBSpan = document.getElementById('checkPBSpan');
    if (checkPBSpan) checkPBSpan.style.display = 'none';

    // ✅ Attach histogram listener

  });
};

// Get the new buttons and modal elements
const saveTop18Button = document.getElementById('saveTop18Button');
const loadTop18Button = document.getElementById('loadTop18Button');
const loadTop18Modal = document.getElementById('loadTop18Modal');
const loadTop18FileInput = document.getElementById('loadTop18FileInput');
const closeLoadModal = document.getElementById('closeLoadModal');

// Event listener for "Save Top 18" button
saveTop18Button.addEventListener('click', saveTop18Numbers);

// Event listener for "Load Top 18" button
loadTop18Button.addEventListener('click', () => {
    loadTop18Modal.style.display = 'block';
});

// Event listener for closing the modal
closeLoadModal.addEventListener('click', () => {
    loadTop18Modal.style.display = 'none';
});

// Event listener for file input change
loadTop18FileInput.addEventListener('change', handleTop18FileSelect);

document.getElementById('methodologyBtn').addEventListener('click', () => {
  document.getElementById('methodologyModal').style.display = 'block';
});
document.getElementById('closeMethodology').addEventListener('click', () => {
  document.getElementById('methodologyModal').style.display = 'none';
});
window.addEventListener('click', (event) => {
  if (event.target.id === 'methodologyModal') {
    document.getElementById('methodologyModal').style.display = 'none';
  }
});

window.onload = function () {
  const exportBtn = document.getElementById('exportAutoTopBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', () => {
    
  const weeks = document.getElementById('weeksInput').value || '00';
  const coverage = document.querySelector('input[name="coverage"]:checked')?.value || '00';
  const nextDraw = (typeof latestDrawingNumber === 'number') ? latestDrawingNumber + 1 : '00000';
  const prefix = (totalNumbersGlobal === 69) ? 'auto_topPB' :
                 (totalNumbersGlobal === 39) ? 'auto_topF5' : 'auto_topX';

  const inputs = Array.from(document.querySelectorAll('#top18Inputs input'));
  const numbers = inputs.map(inp => parseInt(inp.value.trim(), 10)).filter(n => !isNaN(n));
  const sorted = numbers.sort((a, b) => a - b);
  const content = sorted.join(', ');

  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${prefix}_${weeks}_${coverage}_${nextDraw}.txt`;

  // ✅ Trigger the download
  document.body.appendChild(link);
  link.click();

  // ✅ Clean up and close modal safely after short delay
  setTimeout(() => {
    URL.revokeObjectURL(url);
    link.remove();
    document.getElementById('autoPickModal').style.display = 'none';
  }, 100);
});
  }
};


document.addEventListener('DOMContentLoaded', () => {
  const closeAutoBtn = document.getElementById('closeAutoPickModal');
  if (closeAutoBtn) {
    closeAutoBtn.addEventListener('click', () => {
      document.getElementById('autoPickModal').style.display = 'none';
    });
  }

const runAutoBtn = document.getElementById('runAutoPick');
if (runAutoBtn) {
  runAutoBtn.addEventListener('click', () => {
    const weeks = Math.min(25, Math.max(1, parseInt(document.getElementById('weeksInput').value, 10) || 25));
    const count = parseInt(document.querySelector('input[name="coverage"]:checked').value, 10);

    // Build frequency map from the last `weeks` draws
    const recentDraws = fullData.slice(0, weeks).map(row => row.slice(1).map(Number));
    const freqMap = {};
    recentDraws.forEach(draw => {
      draw.forEach(num => {
        if (!isNaN(num)) freqMap[num] = (freqMap[num] || 0) + 1;
      });
    });

    // Top `count` numbers by frequency
    const topNums = Object.entries(freqMap)
      .sort((a, b) => b[1] - a[1])
      .slice(0, count)
      .map(([num]) => parseInt(num, 10))
      .sort((a, b) => a - b);

    // 🔥 Update HOT column only (do not touch Top inputs / top18)
    hotSet = new Set(topNums);

    // Repaint Hits table so the Hot column reflects the change
    renderReverseHitsTable();

    // Optionally close the modal:
    // document.getElementById('autoPickModal').style.display = 'none';
  });
}


  const showAutoBtn = document.getElementById('autoPickTopBtn');
  if (showAutoBtn) {
    showAutoBtn.addEventListener('click', () => {
      document.getElementById('saveTop18Button').style.display = 'none';
      document.getElementById('autoPickModal').style.display = 'block';
    });
  }
  
    // ✅ Attach System Picks button once
  const sysBtn = document.getElementById('systemPicksButton');
  if (sysBtn) {
    sysBtn.addEventListener('click', runSystemPicks);
  }

});

// Holds current System Picks result
let systemPicksSet = new Set();
let hotSet = new Set();   // ✅ holds last Auto-Pick result for the "Hot" column


// Grab the first 12 values from the Top Numbers inputs (left side of the red divider)
function getTopSkipsFromInputs(limit = 12) {
  const nums = Array.from(document.querySelectorAll('#top18Inputs input'))
    .map(inp => parseInt(inp.value.trim(), 10))
    .filter(n => !isNaN(n));
  return nums.slice(0, limit).sort((a,b)=>a-b);
}

// Replicates the Auto-Pick logic (weeks=25, top 12) to produce "topHits"
function computeTopHitsFromRecent(weeks = 25, count = 12) {
  if (!fullData || !fullData.length) return [];
  const recentDraws = fullData.slice(0, Math.min(weeks, fullData.length))
    .map(row => row.slice(1).map(Number));

  const freq = {};
  recentDraws.forEach(draw => {
    draw.forEach(n => {
      if (!isNaN(n)) freq[n] = (freq[n] || 0) + 1;
    });
  });

  return Object.entries(freq)
    .sort((a,b)=> b[1]-a[1])
    .slice(0, count)
    .map(([n]) => parseInt(n,10))
    .sort((a,b)=>a-b);
}

function getTopNumbersByFrequency(weeks, count){
  const w = Math.min(weeks, fullData.length);
  const recentDraws = fullData.slice(0, w)
    .map(row => row.slice(1).map(Number).filter(n => !isNaN(n)));

  const freq = {};
  recentDraws.forEach(draw => draw.forEach(n => { freq[n] = (freq[n] || 0) + 1; }));

  return Object.entries(freq)
    .sort((a,b) => (b[1]-a[1]) || (parseInt(a[0]) - parseInt(b[0])))
    .slice(0, count)
    .map(([n]) => parseInt(n, 10))
    .sort((a,b) => a - b);
}

function readTopSkips12(){
  // first 12 inputs in Top Numbers strip (left of the red divider)
  const inputs = Array.from(document.querySelectorAll('#top18Inputs input'));
  const first12 = inputs.slice(0, 12)
    .map(inp => parseInt(inp.value.trim(), 10))
    .filter(n => !isNaN(n));
  // de-dup + sorted
  return Array.from(new Set(first12)).sort((a,b) => a - b);
}

function runSystemPicks(){
  // Not meaningful in 26-ball “PB-only” mode
  if (totalNumbersGlobal === 26){
    alert('System Picks are not available in Powerball-only mode.');
    return;
  }

  // A) topSkips = first 12 values from Top Numbers inputs
  const topSkips = readTopSkips12();

  // B) topHits = Auto-Pick style for last 25 drawings, Top-12
  const topHits = getTopNumbersByFrequency(25, 12);

  const N = totalNumbersGlobal;

  const topSkipsSet = new Set(topSkips);
  const topHitsSet  = new Set(topHits);

  // C) Intersection (common)
  const common = topSkips.filter(n => topHitsSet.has(n));
  const commonSet = new Set(common);

  // D) Union (numbers mentioned by either list)
  const unionSet = new Set([...topSkips, ...topHits]);

  // E) Remaining = union − common
  const remaining = [...unionSet].filter(n => !commonSet.has(n));

  // F) Neighbors of each remaining number (bounded to 1..N)
  const neighborSet = new Set();
  for (const y of remaining){
    if (y - 1 >= 1)  neighborSet.add(y - 1);
    if (y + 1 <= N)  neighborSet.add(y + 1);
  }

  // G) Final Picks = common ∪ neighbors(remaining)
  systemPicksSet = new Set([...common, ...neighborSet]);

  // H) Re-render to show green dots in “Picks” column
  renderReverseHitsTable();
}


function drawHistogram(points) {
  const maxToShow = 500;
  const recentPoints = points.slice(-maxToShow).reverse(); // latest at top
  const canvasWidth = 800;
  const barHeight = 18;
  const spacing = 4;
  const canvasHeight = (barHeight + spacing) * recentPoints.length;
  
  document.getElementById('histogramModal').style.display = 'block';

  // Remove existing if any
  const oldCanvas = document.getElementById('pointsCanvas');
  if (oldCanvas) oldCanvas.remove();

  const canvas = document.createElement('canvas');
  canvas.id = 'pointsCanvas';
  canvas.width = canvasWidth;
  canvas.height = canvasHeight;
  canvas.style.display = 'block';
  canvas.style.margin = '20px auto';
  canvas.style.border = '2px solid gray';
  canvas.style.background = '#111';

  document.getElementById('histogramContent').appendChild(canvas);

  const ctx = canvas.getContext('2d');
const sorted = [...recentPoints].sort((a, b) => a - b);
const cutoffIndex = (totalNumbersGlobal === 39)
  ? sorted.length - 1         // use full max for 39-game
  : Math.floor(sorted.length * 0.95);  // clamp to 95th percentile for 69-game

const maxPoints = sorted[cutoffIndex];

  ctx.font = '14px Arial';
  ctx.textBaseline = 'middle';

recentPoints.forEach((pts, i) => {
  const y = i * (barHeight + spacing);
  const logPts = Math.log10(pts + 1);
  const logMax = Math.log10(maxPoints + 1);
  const barWidth = (logPts / logMax) * (canvasWidth - 150);

  ctx.fillStyle = pts > 1200 ? 'red' :
                  pts > 800  ? 'orange' :
                  pts > 400  ? 'yellow' :
                               'lightgreen';

  ctx.fillRect(140, y, barWidth, barHeight);
  
  const offset = (totalNumbersGlobal === 39) ? 70 :
                 (totalNumbersGlobal === 69) ? 260 : 0;
  ctx.fillStyle = 'white';
  ctx.fillText(`Draw ${points.length - i + offset}:`, 10, y + barHeight / 2);
  ctx.fillText(`${pts.toFixed(1)} pts`, 150 + barWidth, y + barHeight / 2);
});
}


function setupHistogramListener() {
  const histoBtn = document.getElementById('showHistogramBtn');
  if (!histoBtn) return;

  histoBtn.onclick = () => {
    if (!fullData || !fullData.length) {
      alert("Load drawing data first.");
      return;
    }

    const drawingSets = fullData.map(row =>
      row.slice(1).map(n => parseInt(n)).filter(n => !isNaN(n))
    );
    const points = drawingSets.map(set => calculateRawPointsForSet(set));
    drawHistogram(points);
  };
}

function saveTop18Numbers() {
  /* ── 1. Collect numbers from the Hits table’s Top column ────────── */
  const numbers = [];
  const rows = document.querySelectorAll('#reverseHitsContainer table tr');

  // skip header row (index 0)
  rows.forEach((row, idx) => {
    if (idx === 0) return;                                    // header
    const topCell = row.querySelector('td:last-child');
    if (!topCell) return;

    // any dot → this number is in the Top list
    if (topCell.querySelector('.orange-dot, .blue-dot')) {
      const th = row.querySelector('th');
      const num = th ? parseInt(th.textContent, 10) : NaN;
      if (!isNaN(num)) numbers.push(num);
    }
  });

  const count   = numbers.length;                 // 5, 12, 18 … or error
  const allowed = [5, 12, 18];

  if (!allowed.includes(count)) {
    alert(`The Hits table currently shows ${count || 'no'} numbers in the ‘Top’ column.\n` +
          `Please make sure it’s exactly 5, 12, or 18 before saving.`);
    return;                                       // stop – nothing saved
  }

  /* ── 2. Work out the next drawing number ─────────────────────────── */
  const nextDraw =
    (typeof latestDrawingNumber === 'number' && !isNaN(latestDrawingNumber))
      ? latestDrawingNumber + 1
      : '00000';   
      
  /* ── 2 ½.  Grab the “Number of weeks” value (if the field exists) ── */
  const weeksField = document.getElementById('weeksInput');
  // default “00” if the modal isn’t open or value is missing
  const weeksVal   = weeksField ? (weeksField.value.padStart(2,'0') || '00') : '00';                               // fallback if not loaded

  /* ── 3. Build the filename ───────────────────────────────────────── */
  let filename;
  if (totalNumbersGlobal === 69) {
    filename = `topPB_${count}_${weeksVal}_${nextDraw}.txt`;
  } else if (totalNumbersGlobal === 39) {
    filename = `topF5_${count}_${weeksVal}_${nextDraw}.txt`;
  } else {
    filename = `top_${count}_${weeksVal}_${nextDraw}.txt`;    // PB-only / misc.
  }

  /* ── 4. Save the file ────────────────────────────────────────────── */
  const blob = new Blob([numbers.join(',')], { type: 'text/plain' });
  const link = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob),
    download: filename
  });
  link.click();
}


function handleTop18FileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const contents = e.target.result;
        const numbers = contents.split(',').map(n => parseInt(n.trim(), 10)).filter(n => !isNaN(n));

//        if (numbers.length !== 18) {
//            alert('Invalid file format. Please ensure the file contains 18 comma-separated numbers.');
//            return;
//        }

        loadTop18NumbersIntoTable(numbers);
        loadTop18Modal.style.display = 'none'; // Close the modal
    };
    reader.readAsText(file);
}

function loadTop18NumbersIntoTable(numbers) {
    // Clear the "Top" column and replace orange dots with blue dots
    const container = document.getElementById('reverseHitsContainer');
    if (!container) return;

    const table = container.querySelector('table');
    if (!table) return;

    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
        const topCell = row.querySelector('td:last-child'); // Select the last cell ("Top" column)
        if (topCell) {
            topCell.innerHTML = ''; // Clear existing content (orange dot)
        }
    });

    // Update the top18 array and input fields
    top18 = numbers;
    const top18Inputs = Array.from(document.querySelectorAll('#top18Inputs input'));
    top18Inputs.forEach((input, index) => {
        input.value = numbers[index];
    });

    // Now, add blue dots to the "Top" column for the loaded numbers
    rows.forEach(row => {
        const num = parseInt(row.querySelector('th')?.textContent, 10);
        if (numbers.includes(num)) {
            const topCell = row.querySelector('td:last-child');
            if (topCell) {
                const blueDot = document.createElement('div');
                blueDot.className = 'blue-dot';
                topCell.appendChild(blueDot);
            }
        }
    });

    reapplySkipTableHighlights(); // Update skip table highlights
    loadTop18FileInput.value = '';
}

window.addEventListener('click', (event) => {
    if (event.target === loadTop18Modal) {
        loadTop18Modal.style.display = 'none';
    }
});

// Add CSS for the blue dot (if not already present)
const style = document.createElement('style');
style.textContent = `
    .blue-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin: auto;
        background: lightgreen;
    }
`;
document.head.appendChild(style);


function highlight(btn){
    [btn39, btn69, btn1].forEach(b => b.classList.toggle('active', b === btn));
}

function hidePBblock(){
    pbBlk.style.display = 'none';
    qsa('#pbBlock input').forEach(inp => inp.value = '');
}

function closeCheckModal() {
  const modal = document.getElementById("checkNumbersModal");
  if (modal) modal.style.display = "none";
}

window.addEventListener("click", function(event) {
  const modal = document.getElementById("checkNumbersModal");
  if (event.target === modal) {
    modal.style.display = "none";
  }
});

function showPBblock(){
  pbBlk.style.display='flex';
  const pool  = Array.from({length:26}, (_,i) => i+1);
  const picks = [];
  while (picks.length < 5) {
    const idx = Math.floor(Math.random() * pool.length);
    picks.push( pool.splice(idx,1)[0] );
  }
  qsa('#pbBlock input').forEach((inp,i) => inp.value = picks[i] ?? '');
}

qs('#generateWheelButton').onclick= ()=> qs('#wheelModal').style.display='block';
qs('.close-button').onclick    = ()=> { resetModalControls(); wheelModal.style.display = "none"; reapplySkipTableHighlights(); };
window.onclick = e=>{ if(e.target.id==='wheelModal') { resetModalControls(); wheelModal.style.display='none'; reapplySkipTableHighlights(); } };

qs('#generateSetsModalButton').onclick = generateWheelSets;
qs('#pickBestSetsModal')      .onclick = ()=> pickBestSets(true);
qs('#exportAllBtn')          .onclick = ()=> doExport('all');
qs('#exportBestBtn')         .onclick = ()=> doExport('best');

function doExport(mode){
    if(!generatedSets.length){ alert('Generate sets first!'); return; }

    const allCount  = +qs('#modalSetCountChoice').value||1;
    const bestCount = +qs('#modalBestSetCount').value||1;
    let list = [...generatedSets];

    if(mode==='best'){
        list.sort((a,b)=>a.points-b.points);
        list = list.slice(0,bestCount);
    }else{
        list = list.slice(0,allCount);
    }

    /* figure out bonus-ball pool */
    // grab PB inputs and keep only 1-26
	const pbInputs = qsa('#pbBlock input')
      	.map(inp => parseInt(inp.value, 10))
      	.filter(n => n >= 1 && n <= 26);
	const needPB = (totalNumbersGlobal === 69 || totalNumbersGlobal === 26);

    const lines = list.map(({combo},idx)=>{
        let out = `${idx+1}.  ${combo.join(', ')}`;
        if(needPB){
            const pb = pbInputs.length
                        ? pbInputs[Math.floor(Math.random()*pbInputs.length)]
                        : Math.floor(Math.random()*26)+1;
            out += '  '+pb;
        }
        return out;
    }).join('\n');

    const blob=new Blob([lines],{type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
const prefix = totalNumbersGlobal === 39 ? 'f5' : (totalNumbersGlobal === 26 || 69 ? 'pwb' : 'x');
const draw = latestDrawingNumber + 1 || '00000';
a.download = `${mode}_sets_${prefix}_${draw}.txt`;
    a.click();
}

window.addEventListener('DOMContentLoaded', function() {
  document.getElementById('load39Button').addEventListener('click', function() {
    loadCSVFile('lotto_39.txt', 39);
  });
  document.getElementById('powerball').addEventListener('click', function() {
    loadCSVFile('lotto_69.txt', 69);
  });
  document.getElementById('load1Button').addEventListener('click', function() {
    loadCSVFile('lotto_1.txt', 26);
  });

document.getElementById("checkNumbersButton").onclick = function () {
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = ".txt";

  fileInput.onchange = function (evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const filename = file.name;
    const match = filename.match(/(all|best)_sets_(f5|pwb).*?_(\d+)\.txt$/i);
    if (!match) {
      alert("Filename does not match expected pattern.");
      return;
    }

    const [, , mode, drawNumber] = match;
    const reader = new FileReader();

    reader.onload = function (e) {
      const lines = e.target.result.trim().split("\n").filter(Boolean);
      if (!lines.length) {
        alert("File appears to be empty.");
        return;
      }

      // ✅ Display draw number in the modal header
      const drawLabel = document.getElementById("drawNumberLabel");
      if (drawLabel) drawLabel.textContent = `Drawing #${drawNumber}`;

      // ✅ Load winning numbers from lotto file
      const lottoFile = (mode === "pwb") ? "lotto_69.txt" : "lotto_39.txt";
      fetch(lottoFile + "?t=" + Date.now())
        .then(res => res.ok ? res.text() : Promise.reject("Failed to load lotto file"))
        .then(text => {
          const line = text.trim().split("\n").find(line => line.startsWith(drawNumber + ","));
          if (!line) throw new Error("Drawing number not found in lotto file");

          const parts = line.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
          const nums = parts.slice(1, 6); // skip draw number
          let pb = null;

          if (mode === "pwb") {
            // 🔍 Fetch matching Powerball
            fetch("lotto_1.txt?t=" + Date.now())
              .then(res => res.ok ? res.text() : Promise.reject("Failed to load Powerball file"))
              .then(pbText => {
                const pbLine = pbText.trim().split("\n").find(line => line.startsWith(drawNumber + ","));
                if (!pbLine) throw new Error("Matching Powerball not found for draw #" + drawNumber);
                const pbParts = pbLine.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
                pb = pbParts[1]; // second column = Powerball

                // ✅ Call checker now that PB is available
                checkAgainstSets(lines, nums, pb, mode, drawNumber);
              })
              .catch(err => {
                alert(err);
                console.error("⚠️ Powerball fetch error:", err);
              });
          } else {
            checkAgainstSets(lines, nums, null, mode, drawNumber);
          }
        })
        .catch(err => {
          alert(err);
          console.error("⚠️ Lotto file fetch error:", err);
        });
    };

    reader.readAsText(file);
  };

  fileInput.click();
};

function checkAgainstSets(lines, nums, pb, mode, drawNumber) {
  const winDisplay = document.getElementById("winningNumbersDisplay");
  if (winDisplay) winDisplay.textContent = nums.join(", ");

const pbDisplay = document.getElementById("winningPBDisplay");
if (pbDisplay) {
  if (mode === "pwb" && pb !== null) {
    pbDisplay.textContent = `+ PB: ${pb}`;
    pbDisplay.style.display = "inline";  // in case it’s hidden
  } else {
    pbDisplay.textContent = "";
    pbDisplay.style.display = "none";  // hide it if not used
  }
}

  const matchDiv = document.getElementById("matchResults");
  matchDiv.innerHTML = "";
  let foundMatch = false;

  for (const line of lines) {
    const cleanLine = line.replace(/^\d+\.\s*/, '');
    const numbers = cleanLine.match(/\d+/g)?.map(Number).filter(n => !isNaN(n));
    if (!numbers || numbers.length < 5) continue;

    const picks = numbers.slice(0, 5);
    const bonus = (mode === "pwb" && numbers.length >= 6) ? numbers[5] : null;

    const matchCount = picks.filter(n => nums.includes(n)).length;
    const pbMatch = (mode === "pwb" && pb !== null && bonus === pb);

    let tier = "", color = "";
    if (matchCount === 5 && pbMatch)      { tier = "5 + PB";  color = "red"; }
    else if (matchCount === 5)            { tier = "5";       color = "red"; }
    else if (matchCount === 4 && pbMatch) { tier = "4 + PB";  color = "orange"; }
    else if (matchCount === 4)            { tier = "4";       color = "orange"; }
    else if (matchCount === 3 && pbMatch) { tier = "3 + PB";  color = "yellow"; }
    else if (matchCount === 3)            { tier = "3";       color = "yellow"; }
    else if (matchCount === 2 && pbMatch) { tier = "2 + PB";  color = "green"; }
    else if (matchCount === 1 && pbMatch) { tier = "1 + PB";  color = "green"; }
    else if (pbMatch)                     { tier = "PB Only"; color = "green"; }
    else if (mode === "f5" && matchCount === 2) { tier = "2"; color = "lightblue";}

    if (tier) {
      foundMatch = true;
      const div = document.createElement("div");
	  div.textContent = `${picks.join(', ')} ➔ Matched ${tier}`;
      div.style.color = color;
      matchDiv.appendChild(div);
    }
  }

  if (!foundMatch) {
    const div = document.createElement("div");
    div.textContent = "No matches were found.";
    div.style.color = "yellow";
    matchDiv.appendChild(div);
  }

  // ✅ Load prize table
  const prizeFile = `${mode}_${drawNumber}.txt`;
  fetch(prizeFile + "?t=" + Date.now())
    .then(r => r.ok ? r.text() : Promise.reject("Could not load prize file."))
    .then(text => renderPrizeTable(text))
    .catch(err => {
      console.warn("⚠️ Prize file error:", err);
      const prizeTableDiv = document.getElementById("prizeTable");
      prizeTableDiv.innerHTML = `<p style="color: orange;">${err}</p>`;
    });

  // ✅ Show modal (after everything is ready)
  const modal = document.getElementById("checkNumbersModal");
  if (modal) {
    modal.style.display = "block";
  } else {
    console.warn("⚠️ checkNumbersModal not found in DOM.");
  }
  
  console.log("✅ Winning PB:", pb);

}


function renderPrizeTable(csvText) {
  const lines = csvText.trim().split("\n");
  const prizeTableDiv = document.getElementById("prizeTable");
  prizeTableDiv.innerHTML = ""; // clear previous

  const table = document.createElement("table");
  table.style.borderCollapse = "collapse";
  table.style.marginTop = "10px";
  table.style.width = "100%";

lines.forEach((line, idx) => {
  const row = document.createElement("tr");
  const cells = line.split("\t");

  let rowColor = "lightgreen"; // default

  if (idx !== 0) { // not header
    const tier = cells[0].toLowerCase();
    if (tier.includes("5 of 5")) {
      rowColor = "red";
    } else if (tier.includes("4 of 5")) {
      rowColor = "orange";
    } else if (tier.includes("3 of 5")) {
      rowColor = "yellow";
    } else if (tier.includes("2 of 5")) {
      rowColor = "lightblue";
    } else if (tier.includes("total winning")) {
      rowColor = "gold";
    } else if (tier.includes("5 + Powerball")) {
      rowColor = "red";
    } else if (tier.includes("5")) {
      rowColor = "red"; 
    } else if (tier.includes("4 +")) {
      rowColor = "yellow"; 
    } else if (tier.includes("4")) {
      rowColor = "orange";        
    } else if (tier.includes("3 +")) {
      rowColor = "orange";
    } else if (tier.includes("Powerball")) {
      rowColor = "lightblue"; 
    } else if (tier.includes("3")) {
      rowColor = "lightblue";
    } else if (tier.includes("2 +")) {
      rowColor = "lightblue";
    } else if (tier.includes("1 +")) {
      rowColor = "lightblue";    
    } else if (tier.includes("total winning")) {
      rowColor = "gold";
    }
  }

  cells.forEach(cellText => {
    const cell = document.createElement(idx === 0 ? "th" : "td");
    cell.textContent = cellText;
    cell.style.border = "1px solid gray";
    cell.style.padding = "6px";
    cell.style.textAlign = "left";
    cell.style.color = rowColor;
    row.appendChild(cell);
  });

  table.appendChild(row);
});


  prizeTableDiv.appendChild(table);
}


function processCheckCSV(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const content = e.target.result;
    const lines = content.trim().split("\n");
console.log("📄 File read, contents:", content);
    const nums = Array.from(document.querySelectorAll(".check-num"))
                      .map(n => parseInt(n.value)).filter(n => !isNaN(n));
    const pb = parseInt(document.getElementById("checkPB").value);
    const hasPB = !isNaN(pb) && totalNumbersGlobal === 69;

    const resultsDiv = document.getElementById("matchResults");
    resultsDiv.innerHTML = "";

    let matchFound = false;

    lines.forEach(line => {
      const match = line.trim().match(/^\d+\.\s*(.+?)\s{2,}(\d+)$/);
      
      if (!match) console.warn("❌ Regex failed on line:", line);

      if (!match) return;

      const numberPart = match[1].replace(/\s/g, '');
      const powerball = parseInt(match[2]);

      const picks = numberPart.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
      if (picks.length !== 5) return;

      const matchCount = picks.filter(n => nums.includes(n)).length;
      const pbMatch = hasPB && powerball === pb;

      let tier = "", color = "";
      if (matchCount === 5 && pbMatch)      { tier = "5 + PB";  color = "red";    }
      else if (matchCount === 5)            { tier = "5";       color = "red";    }
      else if (matchCount === 4 && pbMatch) { tier = "4 + PB";  color = "orange"; }
      else if (matchCount === 4)            { tier = "4";       color = "orange"; }
      else if (matchCount === 3 && pbMatch) { tier = "3 + PB";  color = "yellow"; }
      else if (matchCount === 3)            { tier = "3";       color = "yellow"; }
      else if (matchCount === 2 && pbMatch) { tier = "2 + PB";  color = "green";  }
      else if (matchCount === 1 && pbMatch) { tier = "1 + PB";  color = "green";  }
      else if (pbMatch)                     { tier = "PB Only"; color = "green";  }

      if (tier) {
        matchFound = true;
        const div = document.createElement("div");
        div.style.color = color;
        div.textContent = line.trim() + " ➔ " + tier;
        resultsDiv.appendChild(div);
      }
    });

    if (!matchFound) {
      const div = document.createElement("div");
      div.style.color = "yellow";
      div.textContent = "No matches found in any tier.";
      resultsDiv.appendChild(div);
    }
  };
  reader.readAsText(file);
}


document.getElementById('updateHitsBtn').addEventListener('click', updateReverseHitsTop18);



    // Get the "Generate Wheel" button OUTSIDE the modal and add listener to show the modal
    const showModalButton = document.getElementById('generateWheelButton');
    if (showModalButton) {
        showModalButton.addEventListener('click', function() {
            document.getElementById('wheelModal').style.display = "block";
        });
    }

    // Add event listener for the "Generate Sets" button INSIDE the modal
    const generateSetsButtonModal = document.getElementById('generateSetsModalButton');
    if (generateSetsButtonModal) {
        generateSetsButtonModal.addEventListener('click', generateWheelSets);
    }

    if (closeButton) {
        closeButton.addEventListener('click', function() {
            resetModalControls();
            wheelModal.style.display = "none";
            reapplySkipTableHighlights(); // Call the re-highlight function
        });
    }

    if (continueButton) {
        continueButton.addEventListener('click', function() {
            resetModalControls();
            wheelModal.style.display = "none";
            reapplySkipTableHighlights(); // Call the re-highlight function
            // Optionally, you could clear the modal's content here if needed
        });
    }

    if (saveButtonModal) {
        saveButtonModal.addEventListener('click', saveGeneratedSetsToText);
    }

    // Event listener for the "Pick Best Sets" button in the modal
    if (pickBestSetsButtonModal) {
        pickBestSetsButtonModal.addEventListener('click', function() {
            pickBestSets(true); // Display best sets within the modal
        });
    }

    // Optional: Close modal if user clicks outside of it
    window.addEventListener('click', function(event) {
        if (event.target == wheelModal) {
            resetModalControls();
            wheelModal.style.display = "none";
            reapplySkipTableHighlights(); // Call the re-highlight function
        }
    });
});


function loadReferenceData() {
    const refFile = (totalNumbersGlobal === 39)
        ? 'f5_refSet.csv'
        : (totalNumbersGlobal === 69)
            ? 'pwb_refSet.csv'
            : null;

    if (!refFile) {
        console.warn('⚠️ Unsupported totalNumbersGlobal:', totalNumbersGlobal);
        return;
    }

    fetch(refFile + '?t=' + Date.now())
        .then(response => response.text())
        .then(csv => {
            const lines = csv.trim().split('\n');
            referenceData = {}; // 🔄 Clear previous data

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                const category = row[0].trim();
                const diff = parseInt(row[1]);
                const cumP = parseFloat(row[3]);

                if (!referenceData[category]) {
                    referenceData[category] = {};
                }
                referenceData[category][diff] = cumP;
            }

            console.log(`✅ Reference data loaded from ${refFile}:`, referenceData);
        })
        .catch(error => {
            console.error(`❌ Failed to load ${refFile}:`, error);
        });
}


// Call it when page loads
window.addEventListener('DOMContentLoaded', function() {
    loadReferenceData();
});

document.getElementById('quick12Button').addEventListener('click', function () {
    // ✅ Save current edited Top 18 before running Quick
    top18From69 = Array.from(document.querySelectorAll('#top18Inputs input'))
        .map(inp => parseInt(inp.value.trim(), 10))
        .filter(n => !isNaN(n) && n >= 1)
        .sort((a, b) => a - b);
    const allInputs = Array.from(document.querySelectorAll('#top18Inputs input'));
    const topInputs = allInputs
        .map(inp => parseInt(inp.value.trim(), 10))
        .filter(n => !isNaN(n));

    if (topInputs.length < 12) {
        alert('Need at least 12 valid numbers in the Top Numbers inputs.');
        return;
    }

    const fixedPattern = [
        [0, 1, 2, 3, 4], [0, 1, 5, 6, 7], [0, 2, 5, 8, 9],
        [0, 3, 6, 8, 10], [1, 2, 6, 9, 10], [1, 3, 5, 9, 11]
    ];

    let bestOrder = null;
    let bestScore = Infinity;

	const tryCount = 10000;
    for (let i = 0; i < tryCount; i++) {
        const shuffled = topInputs.slice(0, 12).sort(() => 0.5 - Math.random());
        let totalScore = 0;
        for (const indexes of fixedPattern) {
            const combo = indexes.map(i => shuffled[i]);
            totalScore += calculateRawPointsForSet(combo);
        }
        if (totalScore < bestScore) {
            bestScore = totalScore;
            bestOrder = shuffled.slice(0, 12);
        }
    }

    // Update Top18 inputs with best order
    allInputs.forEach((inp, idx) => {
        if (idx < 12) {
            inp.value = bestOrder[idx];
            inp.classList.remove('dimmed');
        } else {
            inp.classList.add('dimmed');
        }
    });

    // Hide modal controls for Quick Mode
    document.getElementById('generateSetsModalButton').style.display = 'none';
    document.getElementById('pickBestSetsModal').style.display = 'none';
    document.getElementById('modalSetCountChoice').style.display = 'none';
    document.getElementById('modalBestSetCount').style.display = 'none';
    document.getElementById('exportBestBtn').style.display = 'none';

    document.querySelectorAll('#wheelModal label').forEach(label => label.style.display = 'none');

    // Build fixed sets and score them
    const fixedSets = fixedPattern.map(indexes => indexes.map(i => bestOrder[i]));
    generatedSets = fixedSets.map(combo => ({
        combo,
        points: calculateRawPointsForSet(combo)
    }));

    // Show output in modal
    const modal = document.getElementById('wheelModal');
    const output = document.getElementById('modalWheelOutput');
    const progress = document.getElementById('progressInfo');

    let html = '<ol>';
    generatedSets.forEach(({ combo, points }) => {
        html += `<li style="color:${getColorForPoints(points)}">${combo.join(', ')} ➔ <b>${points.toFixed(1)} pts</b></li>`;
    });
    html += `</ol><p style="color:orange; font-weight:bold;">  Total Score: ${bestScore.toFixed(1)} pts</p>`;

    output.innerHTML = html;
    if (progress) progress.innerHTML = '';
    modal.style.display = 'block';
});


function renderFixedSetsToModal() {
    const modal = document.getElementById('wheelModal');
    const output = document.getElementById('modalWheelOutput');
    const progress = document.getElementById('progressInfo');

    // Hide modal buttons and inputs
    document.getElementById('generateSetsModalButton').style.display = 'none';
    document.getElementById('pickBestSetsModal').style.display = 'none';
    document.getElementById('modalSetCountChoice').style.display = 'none';
    document.getElementById('modalBestSetCount').style.display = 'none';

    // Populate modal content
    let html = '<ol>';
    generatedSets.forEach(({ combo, points }) => {
        html += `<li style="color:<span class="math-inline">\{getColorForPoints\(points\)\}"\></span>{combo.join(', ')} ➔ <b>${points.toFixed(1)} pts</b></li>`;
    });
    html += '</ol>';
    output.innerHTML = html;

    if (progress) progress.innerHTML = '';
    modal.style.display = 'block';
}

function resetModalControls() {
    document.getElementById('generateSetsModalButton').style.display = 'inline-block';
    document.getElementById('pickBestSetsModal').style.display = 'inline-block';
    document.getElementById('modalSetCountChoice').style.display = 'inline-block';
    document.getElementById('modalBestSetCount').style.display = 'inline-block';
    document.getElementById('exportBestBtn').style.display = 'inline-block';

    const labels = document.querySelectorAll('#wheelModal label');
    labels.forEach(label => label.style.display = 'inline-block');

    // 🔄 Reset dimmed inputs
    document.querySelectorAll('#top18Inputs input.dimmed').forEach(inp => inp.classList.remove('dimmed'));

    // Clear output areas
    const output = document.getElementById('modalWheelOutput');
    const progress = document.getElementById('progressInfo');
    if (output) output.innerHTML = '';
    if (progress) progress.innerHTML = '';
}

function reapplySkipTableHighlights() {
    const table = document.querySelector('#skipFrequencyContainer table');
    if (!table) return;

    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
        const num = parseInt(row.querySelector('th')?.textContent, 10);
        row.querySelectorAll('td').forEach((cell, i) => {
            const val = parseInt(cell.textContent.trim());
            cell.classList.remove('selected-top-skip', 'top18-selected', 'hit');

            if (val > 0) {
                cell.classList.add('hit');
            }
            if (sinceMap[num] === i + 1) {
                cell.classList.add('selected-top-skip');
            }
        });

        if (top18.includes(num)) {
            row.querySelectorAll('td').forEach(cell => {
                if (cell.classList.contains('selected-top-skip')) {
                    cell.classList.remove('selected-top-skip');
                    cell.classList.add('top18-selected');
                }
            });
        }
    });

    // Re-highlight based on the active game mode if it's 69
    if (activeGameMode === 69) {
        const top18Inputs = Array.from(document.querySelectorAll('#top18Inputs input'))
            .map(input => parseInt(input.value.trim(), 10))
            .filter(n => !isNaN(n));

        rows.forEach(row => {
            const num = parseInt(row.querySelector('th')?.textContent, 10);
            if (top18Inputs.includes(num)) {
                row.querySelectorAll('td').forEach(cell => {
                    if (cell.classList.contains('selected-top-skip')) {
                        cell.classList.remove('selected-top-skip');
                        cell.classList.add('top18-selected');
                    }
                });
            }
        });
    } else if (activeGameMode === 26) { // Re-highlight for 1-number mode (if needed - logic might be the same)
        const top18Inputs = Array.from(document.querySelectorAll('#top18Inputs input'))
            .map(input => parseInt(input.value.trim(), 10))
            .filter(n => !isNaN(n));

        rows.forEach(row => {
            const num = parseInt(row.querySelector('th')?.textContent, 10);
            if (top18Inputs.includes(num)) {
                row.querySelectorAll('td').forEach(cell => {
                    if (cell.classList.contains('selected-top-skip')) {
                        cell.classList.remove('selected-top-skip');
                        cell.classList.add('top18-selected');
                    }
                });
            }
        });
    }
}

closeButton.addEventListener('click', function() {
    resetModalControls();
    wheelModal.style.display = "none";
    reapplySkipTableHighlights();
});

window.addEventListener('click', function(event) {
    if (event.target == wheelModal) {
        resetModalControls();
        wheelModal.style.display = "none";
        reapplySkipTableHighlights();
    }
});

window.addEventListener('DOMContentLoaded', function() {
    loadReferenceData();  // already present
    resetModalControls(); // <-- add this
});

function loadCSVFile(filename, totalNumbers, callback, isPowerball69 = false) {
    fetch(filename + '?t=' + Date.now())
        .then(response => response.text())
        .then(text => {
            fullData = text.trim().split('\n').map(line => line.split(',').map(n => n.trim()));
            const drawingNumbers = fullData.map(row => parseInt(row[0]));
            latestDrawingNumber = drawingNumbers[0];

            const lastDrawElem = document.getElementById('lastDrawingNumber');
            if (lastDrawElem) {
                lastDrawElem.textContent = latestDrawingNumber || '–';
            } else {
                console.warn("⚠️ Element with ID 'lastDrawingNumber' not found.");
            }

            const data = fullData.map(row => row.slice(1).map(n => parseInt(n)))
                .filter(row => row.every(n => !isNaN(n)));

            totalNumbersGlobal = totalNumbers;
            hotSet.clear();  // ✅ reset Hot when switching datasets

            skipDataGlobal = buildSkipTable(data, totalNumbers, drawingNumbers);

            pastDrawings = fullData.filter(row => row.length >= 6)
                .map(row => row.slice(1, 6).map(n => parseInt(n)).sort((a, b) => a - b).join(','));

            renderRecentDraws(data, totalNumbers, drawingNumbers[0]);

            const quick12Btn = document.getElementById('quick12Button');
            if (quick12Btn) quick12Btn.style.display = (totalNumbers === 26) ? 'none' : 'inline-block';

const genBtn = document.getElementById('generateWheelButton');
if (genBtn) {
  genBtn.style.display = (totalNumbers === 69 || totalNumbers === 39) ? 'inline-block' : 'none';
}


            const topInputs = document.getElementById('top18Inputs');
if (topInputs) topInputs.style.display = (totalNumbers === 26) ? 'none' : 'flex';

            const exportAllButton = document.querySelector('button[onclick="exportGeneratedSets()"]');
            if (exportAllButton) exportAllButton.style.display = 'inline-block';

            const exportBestButton = document.querySelector('button[onclick="exportBestSets()"]');
            if (exportBestButton) exportBestButton.style.display = 'inline-block';

            const updateHitsButton = document.querySelector('button[onclick="updateReverseHitsTop18()"]');
            if (updateHitsButton) updateHitsButton.style.display = 'inline-block';

            const reverseHits = document.getElementById('reverseHitsContainer');
            if (reverseHits) reverseHits.style.display = 'block';

            const skipFreq = document.getElementById('skipFrequencyContainer');
            if (skipFreq) skipFreq.style.display = 'block';

            if (typeof callback === 'function') {
                callback();
            }
        })
        .catch(error => {
            console.error('Failed to load file:', error);
            alert('Error loading the file.');
        });
}

function buildSkipTable(data, totalNumbers, drawingNumbers) {
    const skipTable = Array.from({ length: totalNumbers + 1 }, () => Array(26).fill(0));
    const lastSeen = Array(totalNumbers + 1).fill(null);

    for (let drawIndex = 0; drawIndex < data.length; drawIndex++) {
        const currentDraw = new Set(data[drawIndex]);
        for (let num = 1; num <= totalNumbers; num++) {
            if (currentDraw.has(num)) {
                if (lastSeen[num] !== null) {
                    const skip = drawIndex - lastSeen[num] - 1;
                    if (skip >= 1 && skip <= 25) {
                        skipTable[num][skip]++;
                    }
                }
                lastSeen[num] = drawIndex;
            }
        }
    }
    return { skipTable };
}

function renderRecentDraws(data, totalNumbers, latestDrawingNumber) {
    const container = document.getElementById('recentDrawsContainer');
    const comment = document.getElementById('latestDrawingComment');
    comment.textContent = `The latest drawing on file is drawing # ${latestDrawingNumber}, shown in column 1.`;

    const draws = data.slice(0, 25);
    while (draws.length < 25) draws.push([]);

    sinceMap = {};
    const table = document.createElement('table');
    const headerRow = document.createElement('tr');
    headerRow.appendChild(document.createElement('th'));
    for (let i = 1; i <= 25; i++) {
        const th = document.createElement('th');
        th.textContent = i;
        headerRow.appendChild(th);
    }
    table.appendChild(headerRow);

    for (let number = 1; number <= totalNumbers; number++) {
        const row = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = number;
        row.appendChild(th);

        let found = false;
        for (let col = 0; col < 25; col++) {
            const cell = document.createElement('td');
            if (draws[col] && draws[col].includes(number)) {
                const dot = document.createElement('div');
                dot.className = 'red-dot';
                cell.appendChild(dot);
                if (!found) {
                    sinceMap[number] = col + 1;
                    found = true;
                }
            }
            row.appendChild(cell);
        }
        if (!found) {
			sinceMap[number] = draws.length + 1;
        }
        table.appendChild(row);
    }

    container.innerHTML = '';
    container.appendChild(table);
}

function rehighlightSkipTableFromTop18() {
    const table = document.querySelector('#skipFrequencyContainer table');
    if (!table) return;

    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
        const num = parseInt(row.querySelector('th')?.textContent, 10);
        row.querySelectorAll('td').forEach((cell, i) => {
            const val = parseInt(cell.textContent.trim());
            cell.classList.remove('selected-top-skip', 'top18-selected', 'hit');

            if (val > 0) {
                cell.classList.add('hit');
            }
            if (sinceMap[num] === i + 1) {
                cell.classList.add('selected-top-skip');
            }
        });

        if (top18.includes(num)) {
            row.querySelectorAll('td').forEach(cell => {
                if (cell.classList.contains('selected-top-skip')) {
                    cell.classList.remove('selected-top-skip');
                    cell.classList.add('top18-selected');
                }
            });
        }
    });
}

function generateTopNumbersAndRender(isPowerball69 = false) {

    const container = document.getElementById('skipFrequencyContainer');
    container.innerHTML = '';

    const table = document.createElement('table');
    const headerRow = document.createElement('tr');
    headerRow.appendChild(document.createElement('th'));
    for (let i = 1; i <= 25; i++) {
        const th = document.createElement('th');
        th.textContent = i;
        headerRow.appendChild(th);
    }
    table.appendChild(headerRow);

    const highlighted = [];

    for (let number = 1; number <= totalNumbersGlobal; number++) {
        const row = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = number;
        row.appendChild(th);

        for (let i = 1; i <= 25; i++) {
            const cell = document.createElement('td');
            const val = skipDataGlobal.skipTable[number]?.[i] || 0;
            cell.textContent = val > 0 ? val : '';

            if (sinceMap[number] === i) {
                cell.classList.add('selected-top-skip');
                highlighted.push({ number, val });
            } else if (val > 0) {
                cell.classList.add('hit');
            }
            row.appendChild(cell);
        }
        table.appendChild(row);
    }

    container.appendChild(table);

    console.log('🔍 Highlighted (pre-sort):', highlighted.map(h => `#${h.number} → ${h.val}`));
    highlighted.sort((a, b) => b.val - a.val);
    top18 = highlighted.slice(0, 12).map(obj => obj.number).sort((a, b) => a - b);
    console.log('✅ Final top18:', top18);

    const top18InputsDiv = document.getElementById('top18Inputs');
    top18InputsDiv.innerHTML = '';
    for (let i = 0; i < top18.length; i++) {
        if (i === 12) {
            const divider = document.createElement('div');
            divider.style.borderLeft = '3px solid red';
            divider.style.margin = '0 6px';
            divider.style.height = '34px';
            divider.style.alignSelf = 'center';
            top18InputsDiv.appendChild(divider);
        }

        const inp = document.createElement('input');
        inp.type = 'text';
        inp.value = top18[i];
        top18InputsDiv.appendChild(inp);
    }

    const allRows = table.querySelectorAll('tr');
    allRows.forEach(row => {
        const num = parseInt(row.querySelector('th')?.textContent, 10);
        if (top18.includes(num)) {
            row.querySelectorAll('td').forEach(cell => {
                if (cell.classList.contains('selected-top-skip')) {
                    cell.classList.remove('selected-top-skip');
                    cell.classList.add('top18-selected');
                }
            });
        }
    });

    renderReverseHitsTable();

    if (isPowerball69) {
        top18From69 = [...top18];
        fullDataFrom69 = [...fullData];
        skipDataGlobalFrom69 = JSON.parse(JSON.stringify(skipDataGlobal));
        sinceMapFrom69 = { ...sinceMap };
        pastDrawingsFrom69 = [...pastDrawings];
        console.log('✅ Saved top18From69:', top18From69);
    }
}

function getColorForPoints(points) {
    if (points < 400) return 'lightgreen';
    if (points < 800) return 'yellow';
    if (points < 1200) return 'orange';
    return 'red';
}

function calculateRawPointsForSet(numbers) {
    let totalPoints = 0;
    const sorted = [...numbers].sort((a, b) => a - b);

    const sum = sorted.reduce((a, b) => a + b, 0);
    const spread = sorted[4] - sorted[0];
    const lowHigh = sorted[0] - sorted[4];
    const consecutivePairs = sorted.filter((n, i) => i < 4 && sorted[i + 1] - n === 1).length;
    const oddEven = sorted.filter(n => n % 2 === 1).length - sorted.filter(n => n % 2 === 0).length;
    const midpoint = totalNumbersGlobal / 2;
    const lowHighBalance = sorted.filter(n => n <= midpoint).length - sorted.filter(n => n > midpoint).length;

    const positionDiffs = {
        "1 - 2": sorted[0] - sorted[1],
        "2 - 3": sorted[1] - sorted[2],
        "3 - 4": sorted[2] - sorted[3],
        "4 - 5": sorted[3] - sorted[4]
    };

    const lookup = [
        { category: "Sum", value: sum },
        { category: "Spread", value: spread },
        { category: "Low - High", value: lowHigh },
        { category: "Odd - Even", value: oddEven },
        { category: "LowHigh Balance", value: lowHighBalance },
        { category: "Consecutive Pairs", value: consecutivePairs },
        { category: "1 - 2", value: positionDiffs["1 - 2"] },
        { category: "2 - 3", value: positionDiffs["2 - 3"] },
        { category: "3 - 4", value: positionDiffs["3 - 4"] },
        { category: "4 - 5", value: positionDiffs["4 - 5"] },
        { category: "Min", value: sorted[0] },
        { category: "Max", value: sorted[4] },
        { category: "Center (3rd)", value: sorted[2] }
    ];

    lookup.forEach(({ category, value }) => {
        const p = referenceData[category]?.[value];
        if (p && p > 0) {
            totalPoints += 1 / Math.max(p, 1e-4);
        }
    });

    return totalPoints;
}


function reapply69State() {
    highlight(btn69);
    totalNumbersGlobal = 69;
    hidePBblock();

    fullData = [...fullDataFrom69];
    skipDataGlobal = JSON.parse(JSON.stringify(skipDataGlobalFrom69));
    sinceMap = { ...sinceMapFrom69 };
    pastDrawings = [...pastDrawingsFrom69];
    top18 = [...top18From69];

    console.log('🟢 Reapplying top18From69:', top18);

    // Inject UI
    const top18InputsDiv = document.getElementById('top18Inputs');
    top18InputsDiv.innerHTML = '';
    for (let i = 0; i < top18.length; i++) {
        if (i === 12) {
            const divider = document.createElement('div');
            divider.style.borderLeft = '3px solid red';
            divider.style.margin = '0 6px';
            divider.style.height = '34px';
            divider.style.alignSelf = 'center';
            top18InputsDiv.appendChild(divider);
        }
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.value = top18[i];
        top18InputsDiv.appendChild(inp);
    }

    updateReverseHitsTop18(); // Reflect changes in Hits chart
    renderSkipFrequency();    // Refresh skip table
}


function generateWheelSets() {

console.log("🔎 Generate Wheel Context:");
console.log("top18:", top18);
console.log("totalNumbersGlobal:", totalNumbersGlobal);
console.log("pastDrawings.length:", pastDrawings.length);
console.log("fullData.length:", fullData.length);
console.log("skipDataGlobal:", skipDataGlobal);
console.log("sinceMap:", sinceMap);

    const top18Inputs = Array.from(document.querySelectorAll('#top18Inputs input'));
const numbersToUse = top18Inputs
  .map(input => parseInt(input.value.trim(), 10))
  .filter(x => !isNaN(x) && x >= 1);
console.log("🧪 Parsed top18 inputs:", numbersToUse);


    if (numbersToUse.length === 0) {
        alert('Please enter valid numbers in the Top 18 Numbers section.');
        return;
    }

    top18 = numbersToUse.sort((a, b) => a - b);

    // Ensure progressDiv exists *before* calling generateWheel
    const progressDiv = document.getElementById('progressInfo') || createProgressInfoDiv();
    progressDiv.innerHTML = ''; // Clear any previous progress

    // Get the number of sets to generate from the modal input
    const setsToGenerateInput = document.getElementById('modalSetCountChoice');
    const setsToGenerate = parseInt(setsToGenerateInput.value, 10) || 6;

    const wheelSets = generateWheel(top18, pastDrawings, 5, setsToGenerate);

    generatedSets = wheelSets.map(({ combo }) => ({ combo, points: calculateRawPointsForSet(combo) }));

    const modalWheelOutput = document.getElementById('modalWheelOutput');
    const wheelModal = document.getElementById('wheelModal');

    if (generatedSets.length === 0) {
        modalWheelOutput.innerHTML = '<p>No valid sets generated. Try different numbers or sets.</p>';
        wheelModal.style.display = "block"; // Show even if no sets
        return;
    }

    let outputHtml = '<ol>';
    generatedSets.forEach(({ combo, points }) => {
        const color = getColorForPoints(points);
        outputHtml += `<li style="color:${color};">${combo.join(', ')} ➔ <b>${points.toFixed(1)} pts</b></li>`;
    });
    outputHtml += '</ol>';
    modalWheelOutput.innerHTML = outputHtml;
    wheelModal.style.display = "block"; // Show the modal

    // renderReverseHitsTable(); <----- REMOVED THIS LINE
}

document.addEventListener('DOMContentLoaded', function() {
document.querySelectorAll('.close-button').forEach(btn => {
  btn.addEventListener('click', function () {
    const modal = this.closest('.modal');
    if (modal) {
      modal.style.display = 'none';
      if (modal.id === 'wheelModal') resetModalControls();
      if (modal.id === 'checkNumbersModal') reapplySkipTableHighlights();
    }
  });
});
    const wheelModal = document.getElementById('wheelModal');
    const continueButton = document.getElementById('continueButton');
    const saveButtonModal = document.getElementById('saveGeneratedSetsModal');
    const pickBestSetsButtonModal = document.getElementById('pickBestSetsModal'); // New button

    if (closeButton) {
closeButton.addEventListener('click', function () {
    resetModalControls();
    wheelModal.style.display = "none";

    if (totalNumbersGlobal === 26) {
        reapply69State();
    }
});
    }

    if (continueButton) {
        continueButton.addEventListener('click', function() {
            wheelModal.style.display = "none";
            // Optionally, you could clear the modal's content here if needed
        });
    }

    if (saveButtonModal) {
        saveButtonModal.addEventListener('click', saveGeneratedSetsToText);
    }

    // Event listener for the "Pick Best Sets" button in the modal
    if (pickBestSetsButtonModal) {
        pickBestSetsButtonModal.addEventListener('click', function() {
            pickBestSets(true); // Display best sets within the modal
        });
    }

window.addEventListener('click', function (event) {
    if (event.target == wheelModal) {
        resetModalControls();
        wheelModal.style.display = "none";

        if (totalNumbersGlobal === 26) {
            reapply69State();
        }
    }
});


    // Remove the event listener for the old "Pick Best Sets" button outside the modal
    const oldPickBestSetsButton = document.querySelector('button[onclick="pickBestSets()"]');
    if (oldPickBestSetsButton) {
        oldPickBestSetsButton.removeAttribute('onclick');
        // You might want to remove the button element entirely if you don't need it anymore
        // oldPickBestSetsButton.remove();
    }
});

function saveGeneratedSetsToText() {
    if (!generatedSets.length) {
        alert("No generated sets to save!");
        return;
    }

    /* is this the single-number game (the file you load with “Load 1 Numbers”)? */
    const singleNumberGame = (totalNumbersGlobal === 26);

    let text;

    if (singleNumberGame) {
        /* grab whatever is currently in the Top-Numbers inputs */
        const bonusPool = Array.from(document.querySelectorAll('#top18Inputs input'))
              .map(inp => parseInt(inp.value.trim(), 10))
              .filter(n => !isNaN(n));

        if (bonusPool.length === 0) {
            alert("No numbers found in the Top Numbers inputs!");
            return;
        }

        /* each set gets ONE random pick (duplicates allowed) */
        text = generatedSets.map(({ combo }) => {
            const bonus = bonusPool[Math.floor(Math.random() * bonusPool.length)];
            return `${combo.join(', ')}  ${bonus}`;   // two spaces before the bonus
        }).join('\n');
    } else {
        /* legacy format with points */
        text = generatedSets
               .map(({ combo, points }) => `${combo.join(', ')} ➔ ${points.toFixed(1)} pts`)
               .join('\n');
    }

    /* save to txt */
    const blob = new Blob([text], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `generated_sets_${totalNumbersGlobal}.txt`;
    link.click();
}

function pickBestSets(displayInModal = false) {
    if (!generatedSets.length) {
        alert("No wheel sets have been generated yet!");
        return;
    }

    const bestSetCountInput = document.getElementById('modalBestSetCount');
    const bestCount = parseInt(bestSetCountInput.value, 10) || 5;

    // Sort by score ascending (lowest points first)
    generatedSets.sort((a, b) => a.points - b.points);

    // Pick the best sets
    const bestSets = generatedSets.slice(0, bestCount);

    const outputContainer = displayInModal ? document.getElementById('modalWheelOutput') : document.getElementById('wheelOutput');
    let newHtml = '<br><h2>Best ' + bestSets.length + ' Sets:</h2><ol>' + bestSets.map(({ combo, points }) =>
        `<li style="color:${getColorForPoints(points)}; font-weight: bold;">${combo.join(', ')} ➔ <b>${points.toFixed(1)} pts</b></li>`
    ).join('') + '</ol>';

    outputContainer.innerHTML = newHtml;

    if (!displayInModal) {
        const wheelModal = document.getElementById('wheelModal');
        wheelModal.style.display = "none"; // Hide the modal after displaying best sets outside
    }
}

function processLoadedData() {
  const drawingNumbers = fullData.map(row => parseInt(row[0]));

  const data = fullData.map(row => row.slice(1).map(Number))
                       .filter(row => row.every(n => !isNaN(n)));

  skipDataGlobal = buildSkipTable(data, totalNumbersGlobal, drawingNumbers);

  pastDrawings = fullData.filter(row => row.length >= 6)
                         .map(row => row.slice(1, 6).sort((a, b) => a - b).join(','));

  renderRecentDraws(data, totalNumbersGlobal, drawingNumbers[0]);
  renderSkipFrequency();
}

// 🟢 Render Skip Table
function renderSkipFrequency() {
  const container = document.getElementById('skipFrequencyContainer');
  container.innerHTML = '';

  const table = document.createElement('table');
  const headerRow = document.createElement('tr');
  headerRow.appendChild(document.createElement('th'));
  for (let i = 1; i <= 25; i++) {
    const th = document.createElement('th');
    th.textContent = i;
    headerRow.appendChild(th);
  }
  table.appendChild(headerRow);

  for (let number = 1; number <= totalNumbersGlobal; number++) {
    const row = document.createElement('tr');
    const th = document.createElement('th');
    th.textContent = number;
    row.appendChild(th);

    for (let i = 1; i <= 25; i++) {
      const cell = document.createElement('td');
      const val = skipDataGlobal.skipTable[number]?.[i] || 0;
      cell.textContent = val > 0 ? val : '';
      row.appendChild(cell);
    }
    table.appendChild(row);
  }

  container.appendChild(table);
}


function generateWheel(sourceNumbers, pastDrawings, setSize, numSets) {
  const wheel = [];
  const used = new Set();
  const seenCombos = new Set();
  let skippedDueToPastDrawings5 = 0;
  let skippedDueToBadSum = 0;
  let skippedDueToHighPoints = 0;
  let attempts = 0;

  const totalCombosNeeded = combination(sourceNumbers.length, 3);

  const minPossibleSum = sourceNumbers.slice(0, 5).reduce((a, b) => a + b, 0);
  const maxPossibleSum = sourceNumbers.slice(-5).reduce((a, b) => a + b, 0);
  const span = maxPossibleSum - minPossibleSum;
  const minSumAllowed = minPossibleSum + span * 0.15;
  const maxSumAllowed = minPossibleSum + span * 0.85;

  const maxPointsAllowed = 1200;  // 🧠 Set an empirical threshold for point filtering

  const progressDiv = document.getElementById('progressInfo') || createProgressInfoDiv();
  progressDiv.innerHTML = '';

  while (wheel.length < numSets && attempts < 50000) {
    const combo = [...sourceNumbers].sort(() => 0.5 - Math.random()).slice(0, setSize).sort((a, b) => a - b);
    const comboKey = combo.join(',');

    if (used.has(comboKey)) {
      attempts++;
      continue;
    }

    // Sum filter
    const sum = combo.reduce((a, b) => a + b, 0);
    if (sum < minSumAllowed || sum > maxSumAllowed) {
      skippedDueToBadSum++;
      attempts++;
      continue;
    }

    // Jackpot repeat filter (avoid exact past draws)
    let conflict = false;
    for (let i = 0; i < pastDrawings.length; i++) {
      const past = pastDrawings[i].split(',').map(Number);
      const overlap = combo.filter(n => past.includes(n));
      if (overlap.length === 5) {
        skippedDueToPastDrawings5++;
        conflict = true;
        break;
      }
    }
    if (conflict) {
      attempts++;
      continue;
    }

    // Points-based filter 🔥
    const score = calculateRawPointsForSet(combo);
    if (score > maxPointsAllowed) {
      skippedDueToHighPoints++;
      attempts++;
      continue;
    }

    used.add(comboKey);

    const threeCombos = getAllCombinations(combo, 3);
    for (const c of threeCombos) seenCombos.add(c.join(','));

    wheel.push({ combo, points: score });  // ✅ attach score here

    // Update progress
    progressDiv.innerHTML = `
      <div style="color: red;">🔥 Skipped ${skippedDueToPastDrawings5} sets (5/5 match)</div>
      <div style="color: orange;">🚫 Skipped ${skippedDueToBadSum} sets (bad sum)</div>
      <div style="color: violet;">⛔ Skipped ${skippedDueToHighPoints} sets (score > ${maxPointsAllowed})</div>
      <div style="color: lightgreen;">✅ 3-number combos covered: ${seenCombos.size} / ${totalCombosNeeded}</div>
    `;

    if (seenCombos.size >= totalCombosNeeded * 0.95) {
      const doneMessage = document.createElement('div');
      doneMessage.innerHTML = '🎯 95% of 3-combos covered!';
      doneMessage.style.color = 'lime';
      progressDiv.appendChild(doneMessage);
    }

    attempts++;
  }

  return wheel;
}



// Estimate simple % coverage for budget table
function estimateCoverage(numSets, totalNumbers) {
  const combosPerSet = combination(5, 3); // 5 pick 3 = 10 combos per set
  const totalCombos = combination(totalNumbers, 3);
  const coverage = (numSets * combosPerSet) / totalCombos * 100;
  return coverage.toFixed(1);
}

function getAllCombinations(array, size) {
  const results = [];
  function helper(start, combo) {
    if (combo.length === size) {
      results.push(combo);
      return;
    }
    for (let i = start; i < array.length; i++) {
      helper(i + 1, combo.concat(array[i]));
    }
  }
  helper(0, []);
  return results;
}

function combination(n, k) {
  if (k > n) return 0;
  let result = 1;
  for (let i = 0; i < k; i++) {
    result *= (n - i) / (i + 1);
  }
  return Math.round(result);
}

function createProgressInfoDiv() {
    const div = document.createElement('div');
    div.id = 'progressInfo';
    div.style.marginTop = '15px';
    div.style.fontSize = '16px';
    const modalContent = document.querySelector('#wheelModal .modal-content');
    if (modalContent) {
        modalContent.insertBefore(div, document.getElementById('modalWheelOutput'));
    }
    return div;
}

function calculateCoveragePercent(numNumbers, setsGenerated) {
  const totalCombos = combination(numNumbers, 3);  // total 3-number combos possible
  const combosCovered = setsGenerated * combination(5, 3);  // each 5-number set covers 10 combos
  let percent = Math.min(100, (combosCovered / totalCombos) * 100);
  return percent.toFixed(1);
}


function renderReverseHitsTable() {
  const container = document.getElementById('reverseHitsContainer');
  container.innerHTML = '';

  const table = document.createElement('table');

  // Header: 25..1 + "Top" + "Hot" + "Picks"
  const headerRow = document.createElement('tr');
  headerRow.appendChild(document.createElement('th'));
  for (let i = 25; i >= 1; i--) {
    const th = document.createElement('th');
    th.textContent = i;
    headerRow.appendChild(th);
  }
  headerRow.appendChild(document.createElement('th')).textContent = 'Top';
  headerRow.appendChild(document.createElement('th')).textContent = 'Hot';    // ✅ NEW
  headerRow.appendChild(document.createElement('th')).textContent = 'Picks';
  table.appendChild(headerRow);

  const draws = fullData
    .map(row => row.slice(1).map(n => parseInt(n, 10)))
    .slice(0, 25);

  for (let number = 1; number <= totalNumbersGlobal; number++) {
    const row = document.createElement('tr');
    const th = document.createElement('th');
    th.textContent = number;
    row.appendChild(th);

    for (let i = 24; i >= 0; i--) {
      const cell = document.createElement('td');
      if (draws[i] && draws[i].includes(number)) {
        const dot = document.createElement('div');
        dot.className = 'red-dot';
        cell.appendChild(dot);
      }
      row.appendChild(cell);
    }

    // Top column (unchanged; follows the user's Top inputs -> 'top18' array)
    const topCell = document.createElement('td');
    if (totalNumbersGlobal !== 26 && top18.includes(number)) {
      const dot = document.createElement('div');
      dot.className = 'orange-dot';
      topCell.appendChild(dot);
    }
    row.appendChild(topCell);

    // ✅ Hot column (from Auto-Pick results only)
    const hotCell = document.createElement('td');
    if (hotSet && hotSet.has(number)) {
      const d = document.createElement('div');
      d.className = 'hot-dot';
      hotCell.appendChild(d);
    }
    row.appendChild(hotCell);

    // Picks column (from System Picks)
    const picksCell = document.createElement('td');
    if (systemPicksSet && systemPicksSet.has(number)) {
      const b = document.createElement('div');
      b.className = 'green-dot';
      picksCell.appendChild(b);
    }
    row.appendChild(picksCell);

    table.appendChild(row);
  }

  container.appendChild(table);
}


function updateReverseHitsTop18() {

    // Refresh the top18 from current input values
    const top18Inputs = Array.from(document.querySelectorAll('#top18Inputs input'));
    top18 = top18Inputs.map(input => parseInt(input.value.trim(), 10))
                       .filter(x => !isNaN(x) && x >= 1)
                       .sort((a, b) => a - b);

    // Also update the saved Top 18 (in case they close modal later)
    if (totalNumbersGlobal === 69 || totalNumbersGlobal === 26) {
        top18From69 = [...top18];
    }

    renderReverseHitsTable();
    renderSkipFrequency();
    rehighlightSkipTableFromTop18();  // <-- Restore highlight styles
}


// 🟢 Export Generated Sets
function exportGeneratedSets() {
  if (generatedSets.length === 0) {
    alert("No generated sets!");
    return;
  }
  const text = generatedSets.map(({ combo, points }) => `${combo.join(', ')} ➔ ${points.toFixed(1)} pts`).join('\n');
  const blob = new Blob([text], { type: 'text/plain' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'generated_sets_' + totalNumbersGlobal + '.txt';
  link.click();
}

function exportBestSets() {
    if (!generatedSets.length) {
        alert("No generated sets!");
        return;
    }

    const bestCount = parseInt(document.getElementById('bestSetCount').value, 10) || 5;

    const bestSets = generatedSets.slice(0, bestCount);

    if (bestSets.length === 0) {
        alert("No best sets available!");
        return;
    }

    const text = bestSets.map(({ combo, points }) => `${combo.join(', ')} ➔ ${points.toFixed(1)} pts`).join('\n');
    const blob = new Blob([text], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
const prefix = totalNumbersGlobal === 39 ? 'f5' : (totalNumbersGlobal === 26 ? 'pwb' : 'x');
const draw = latestDrawingNumber || '00000';
link.download = `best_sets_${prefix}_${draw}.txt`;
    link.click();
}



// ✅ Check Winning Numbers Logic
document.addEventListener("DOMContentLoaded", function() {
  const fileInput = document.getElementById("checkFileInput");
  if (!fileInput) return;

  fileInput.addEventListener("change", function(evt) {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const content = e.target.result;
      const lines = content.trim().split("\n");

      const nums = Array.from(document.querySelectorAll(".check-num"))
                        .map(n => parseInt(n.value)).filter(n => !isNaN(n));
      const pb = parseInt(document.getElementById("checkPB").value);
      const hasPB = !isNaN(pb) && totalNumbersGlobal === 69;

      const resultsDiv = document.getElementById("matchResults");
      resultsDiv.innerHTML = "";

      let matchFound = false;

      lines.forEach(line => {
        const match = line.trim().match(/^\d+\.\s*(.+?)\s{2,}(\d+)$/);
        if (!match) return;

        const numberPart = match[1].replace(/\s/g, '');
        const powerball = parseInt(match[2]);

        const picks = numberPart.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
        if (picks.length !== 5) return;

        const matchCount = picks.filter(n => nums.includes(n)).length;
        const pbMatch = hasPB && powerball === pb;

        let tier = "", color = "";
        if (matchCount === 5 && pbMatch)      { tier = "5 + PB";  color = "red";    }
        else if (matchCount === 5)            { tier = "5";       color = "red";    }
        else if (matchCount === 4 && pbMatch) { tier = "4 + PB";  color = "orange"; }
        else if (matchCount === 4)            { tier = "4";       color = "orange"; }
        else if (matchCount === 3 && pbMatch) { tier = "3 + PB";  color = "yellow"; }
        else if (matchCount === 3)            { tier = "3";       color = "yellow"; }
        else if (matchCount === 2 && pbMatch) { tier = "2 + PB";  color = "green";  }
        else if (matchCount === 1 && pbMatch) { tier = "1 + PB";  color = "green";  }
        else if (pbMatch)                     { tier = "PB Only"; color = "green";  }

        if (tier) {
          matchFound = true;
          const div = document.createElement("div");
          div.style.color = color;
          div.textContent = line.trim() + " ➔ " + tier;
          resultsDiv.appendChild(div);
        }
      });

      if (!matchFound) {
        const div = document.createElement("div");
        div.style.color = "yellow";
        div.textContent = "No matches found in any tier.";
        resultsDiv.appendChild(div);
      }
    };
    reader.readAsText(file);
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const closeBtn = document.getElementById('closeHistogramModal');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      document.getElementById('histogramModal').style.display = 'none';
    });
  }
});


window.addEventListener('click', event => {
  if (event.target === document.getElementById('histogramModal')) {
    document.getElementById('histogramModal').style.display = 'none';
  }
});

window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('powerball')?.click();
});

window.addEventListener('load', function() {
  // Hide splash screen after 3.5 seconds
  setTimeout(() => {
    const splash = document.getElementById('splashScreen');
    if (splash) {
      splash.style.opacity = 0;
      splash.style.transition = 'opacity 0.5s ease';
      setTimeout(() => splash.remove(), 500); // then remove from DOM
    }

    // Auto-click the 69 button (if you want that too)
    const btn69 = document.getElementById('powerball');
    if (btn69) btn69.click();
  }, 3800); // adjust duration to match your GIF length
});


</script>


</body>
</html>
